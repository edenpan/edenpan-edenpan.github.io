<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="computer, finance, some recording">
<meta property="og:type" content="website">
<meta property="og:title" content="Eden">
<meta property="og:url" content="http://blog.sevenpan.com/index.html">
<meta property="og:site_name" content="Eden">
<meta property="og:description" content="computer, finance, some recording">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Eden">
<meta name="twitter:description" content="computer, finance, some recording">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.sevenpan.com/"/>





  <title>Eden</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Eden</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.sevenpan.com/2019/03/06/java/CoreJava/Java8 并发指南：原子变量和并发Map Atomic Variables and ConcurrentMap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Pan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eden">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/06/java/CoreJava/Java8 并发指南：原子变量和并发Map Atomic Variables and ConcurrentMap/" itemprop="url">Java8 并发指南：原子变量和并发Map(Atomic Variables and ConcurrentMap)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-06T10:15:11+08:00">
                2019-03-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Java8-并发指南：原子变量和并发Map-Atomic-Variables-and-ConcurrentMap"><a href="#Java8-并发指南：原子变量和并发Map-Atomic-Variables-and-ConcurrentMap" class="headerlink" title="Java8 并发指南：原子变量和并发Map Atomic Variables and ConcurrentMap"></a>Java8 并发指南：原子变量和并发Map Atomic Variables and ConcurrentMap</h1><p>from:<a href="https://winterbe.com/posts/2015/05/22/java8-concurrency-tutorial-atomic-concurrent-map-examples/" target="_blank" rel="noopener">https://winterbe.com/posts/2015/05/22/java8-concurrency-tutorial-atomic-concurrent-map-examples/</a></p>
<h2 id="原子类-AtomicInteger"><a href="#原子类-AtomicInteger" class="headerlink" title="原子类 AtomicInteger"></a>原子类 AtomicInteger</h2><p>java.concurrent.atomic包中包含很多有用的类来运行原子操作。操作的原子性是指你可以安全的在多个线程中进行并发操作而不需要使用synchronized关键字。<br>在内部，原子类依赖于Compare-and-swap(CAS)，一个原子指令操作直接被多个现代CPU所支持。这些指令通常比使用锁同步要快很多。所以建议是如果你需要并发改变一个可变变量时，更加偏向于使用原子类而不是锁。<br>下面使用一个原子类作为例子：AtomicInteger</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">AtomicInteger atomicInt = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">ExecutorService executor = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">IntStream.range(<span class="number">0</span>, <span class="number">1000</span>)</span><br><span class="line">    .forEach(i -&gt; executor.submit(atomicInt::incrementAndGet));</span><br><span class="line"></span><br><span class="line">stop(executor);</span><br><span class="line"></span><br><span class="line">System.out.println(atomicInt.get());    <span class="comment">// =&gt; 1000</span></span><br></pre></td></tr></table></figure>
<p>使用ActomicInteger来替换Integer，我们可以并发的增加这个数字而不需要使用同步锁来访问这个变量。incrementAndGet()方法是一个原子操作这样我们可以安全的多线程调用这个方法。<br>AtomicInteger支持多种原子操作。<strong>updateAndGet()</strong>可以接受一个lambda表达式从而来执行任何的算术操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">AtomicInteger atomicInt = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">ExecutorService executor = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">IntStream.range(<span class="number">0</span>, <span class="number">1000</span>)</span><br><span class="line">    .forEach(i -&gt; &#123;</span><br><span class="line">        Runnable task = () -&gt;</span><br><span class="line">            atomicInt.updateAndGet(n -&gt; n + <span class="number">2</span>);</span><br><span class="line">        executor.submit(task);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">stop(executor);</span><br><span class="line"></span><br><span class="line">System.out.println(atomicInt.get());    <span class="comment">// =&gt; 2000</span></span><br></pre></td></tr></table></figure>
<p><strong>accumulateAndGet()</strong>接受另外一种IntBinaryOperator类型的lambda表达式。我们使用这个方法来将0到1000所有数字加起来。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">AtomicInteger atomicInt = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">ExecutorService executor = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">IntStream.range(<span class="number">0</span>, <span class="number">1000</span>)</span><br><span class="line">    .forEach(i -&gt; &#123;</span><br><span class="line">        Runnable task = () -&gt;</span><br><span class="line">            atomicInt.accumulateAndGet(i, (n, m) -&gt; n + m);</span><br><span class="line">        executor.submit(task);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">stop(executor);</span><br><span class="line"></span><br><span class="line">System.out.println(atomicInt.get());    <span class="comment">// =&gt; 499500</span></span><br></pre></td></tr></table></figure>
<p>还有一些原子类，比如：<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/atomic/AtomicBoolean.html" target="_blank" rel="noopener">AtomicBoolean</a>,<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/atomic/AtomicLong.html" target="_blank" rel="noopener">AtomicLong</a>,<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/atomic/AtomicReference.html" target="_blank" rel="noopener">AtomicReference</a>.  </p>
<h2 id="LongAdder"><a href="#LongAdder" class="headerlink" title="LongAdder"></a>LongAdder</h2><p>LongAdder是用于连续的加值到一个数字上除了AtomicLong的另外一种选择。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService executor = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">IntStream.range(<span class="number">0</span>, <span class="number">1000</span>)</span><br><span class="line">    .forEach(i -&gt; executor.submit(adder::increment));</span><br><span class="line"></span><br><span class="line">stop(executor);</span><br><span class="line"></span><br><span class="line">System.out.println(adder.sumThenReset());   <span class="comment">// =&gt; 1000</span></span><br></pre></td></tr></table></figure>
<p>LongAdder 和atomic number一样提供add()和increment()的方法，并且也是线程安全的。不同于只是将单个结果累加起来，这个类维护了一系列的内部变量用来减少线程的竞争.<em>怎么减少的？？</em>实际的结果可以通过sum()或sumThenReset()来获取。<br>当从多个线程中更新的次数多于读的次数时，这个类常常是比原子类更好的选择。比如当你想要获取统计数据的时候，比如你想要获取服务器一共服务了多少的请求。LongAdder的弊端是高内存消耗，因为它有一系列的变量在内存中。</p>
<h2 id="LongAccumulator"><a href="#LongAccumulator" class="headerlink" title="LongAccumulator"></a>LongAccumulator</h2><p>LongAccumulator是LongAdder的一个更加常见的版本。不仅仅是处理一个简单的加操作，LongAccumulator是基于类型为LongBinaryOperator的lambda表达式来构建的。代码sample如下：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LongBinaryOperator op = (x, y) -&gt; <span class="number">2</span> * x + y;</span><br><span class="line">LongAccumulator accumulator = <span class="keyword">new</span> LongAccumulator(op, <span class="number">1L</span>);</span><br><span class="line"></span><br><span class="line">ExecutorService executor = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">IntStream.range(<span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line">    .forEach(i -&gt; executor.submit(() -&gt; accumulator.accumulate(i)));</span><br><span class="line"></span><br><span class="line">stop(executor);</span><br><span class="line"></span><br><span class="line">System.out.println(accumulator.getThenReset());     <span class="comment">// =&gt; 2539</span></span><br></pre></td></tr></table></figure>
<p>我们通过函数<code>2 * x + y</code>和一个初始值来构造一个LongAccumulator。每次调用<code>accumulate(i)</code>时，当前的结果和值i将会被传进lambda表达式中。<br>LongAccumulator也和LongAdder一样维护了一系列的内部变量来减少线程间的竞争。  </p>
<h2 id="ConcurrentMap"><a href="#ConcurrentMap" class="headerlink" title="ConcurrentMap"></a>ConcurrentMap</h2><p>接口ConcurrentMap扩展了map接口并且定义了最有用的并发集合类型。Java 8 通过增加新的方法到这个接口中来引入函数编程。<br>下面的代码用于展示这些新的方法：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ConcurrentMap&lt;String, String&gt; map = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">map.put(<span class="string">"foo"</span>, <span class="string">"bar"</span>);</span><br><span class="line">map.put(<span class="string">"han"</span>, <span class="string">"solo"</span>);</span><br><span class="line">map.put(<span class="string">"r2"</span>, <span class="string">"d2"</span>);</span><br><span class="line">map.put(<span class="string">"c3"</span>, <span class="string">"p0"</span>);</span><br></pre></td></tr></table></figure>
<p>forEach()方法接受一个Biconsumer的lambda表达式将map的key和value作为参数进行传递。这个可以作为替代for-each循环来迭代获取所有的concurrent map。这个迭代会被当前线程顺序执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">map.forEach((key, value) -&gt; System.out.printf(<span class="string">"%s = %s\n"</span>, key, value));</span><br></pre></td></tr></table></figure>
<p>方法putIfAbsent()将新的值放到map中如果这个key没有值。最少在ConcurrentHashMap中这个方法是线程安全的就像put()方法，所以你不要再不同的线程中使用同步。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String value = map.putIfAbsent(<span class="string">"c3"</span>, <span class="string">"p1"</span>);</span><br><span class="line">System.out.println(value);    <span class="comment">// p0</span></span><br></pre></td></tr></table></figure>
<p>方法getOrDefault()返回key对应的value。如果这个key不存在就会返回默认值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String value = map.getOrDefault(<span class="string">"hi"</span>, <span class="string">"there"</span>);</span><br><span class="line">System.out.println(value);    <span class="comment">// there</span></span><br></pre></td></tr></table></figure>
<p>方法replaceAll()接受一个BiFunction的lambda表达式。BiFunction接受两个参数并且返回一个值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">map.replaceAll((key, value) -&gt; <span class="string">"r2"</span>.equals(key) ? <span class="string">"d3"</span> : value);</span><br><span class="line">System.out.println(map.get(<span class="string">"r2"</span>));    <span class="comment">// d3</span></span><br></pre></td></tr></table></figure>
<p>compute方法可以让我们改变一个单独的条目。这个方法接受需要修改的键以及一个bi-function来指定修改这个值的方法。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">map.compute(<span class="string">"foo"</span>, (key, value) -&gt; value + value);</span><br><span class="line">System.out.println(map.get(<span class="string">"foo"</span>));   <span class="comment">// barbar</span></span><br></pre></td></tr></table></figure>
<p>除了compute()，还有两种变体：computeIfAbsent(), computeIfPresent()。这个函数化参数只在key不存在或者存在的时候才会调用。<br>最后，merge()方法可以统一一个新值基于已经存在的值的基础上。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">map.merge(<span class="string">"foo"</span>, <span class="string">"boo"</span>, (oldVal, newVal) -&gt; newVal + <span class="string">" was "</span> + oldVal);</span><br><span class="line">System.out.println(map.get(<span class="string">"foo"</span>));   <span class="comment">// boo was foo</span></span><br></pre></td></tr></table></figure>
<h2 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h2><p>上面的方法都是ConcurrentMap接口的一部分，所以所有实现了这个接口的类都可以使用。另外其中一个重要的实现：ConcurrentHashMap也被增强了加上了一些新的方法来在map上进行并发操作。<br>就像并发流(parallel streams)，这些方法使用一个特殊的通过ForkJoinPool.commonPool()来获取ForkJoinPool。这个池使用一个预先设定的并发值依赖于当前可用CPU的值。四核CPU返回的值如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(ForkJoinPool.getCommonPoolParallelism());  <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>
<p>这个值可以通过修改JVM参数来更改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Djava.util.concurrent.ForkJoinPool.common.parallelism=<span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>我们通过和上一节一样的例子来展示，只是这次我们工作在具体的实现ConcurrentHashMap而不是在接口上，这样我们可以调用这个类的所有public方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ConcurrentHashMap&lt;String, String&gt; map = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">map.put(<span class="string">"foo"</span>, <span class="string">"bar"</span>);</span><br><span class="line">map.put(<span class="string">"han"</span>, <span class="string">"solo"</span>);</span><br><span class="line">map.put(<span class="string">"r2"</span>, <span class="string">"d2"</span>);</span><br><span class="line">map.put(<span class="string">"c3"</span>, <span class="string">"p0"</span>);</span><br></pre></td></tr></table></figure>
<p>Java8介绍了三种并发操作：forEach, search和 reduce。每一个操作都可以接受函数keys,values,entries和key-value对参数。<br>这些方法都有一个共同的第一个参数：parallelismThreshold。这个阀值指定了当操作应该并发的时候最小的集合大小。比如如果阀值是500，而你传递了实际map大小是499，这个时候这个操作会在单个线程顺序执行。</p>
<h3 id="ForEach"><a href="#ForEach" class="headerlink" title="ForEach"></a>ForEach</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">map.forEach(<span class="number">1</span>, (key, value) -&gt;</span><br><span class="line">    System.out.printf(<span class="string">"key: %s; value: %s; thread: %s\n"</span>,</span><br><span class="line">        key, value, Thread.currentThread().getName()));</span><br><span class="line"></span><br><span class="line"><span class="comment">// key: r2; value: d2; thread: main</span></span><br><span class="line"><span class="comment">// key: foo; value: bar; thread: ForkJoinPool.commonPool-worker-1</span></span><br><span class="line"><span class="comment">// key: han; value: solo; thread: ForkJoinPool.commonPool-worker-2</span></span><br><span class="line"><span class="comment">// key: c3; value: p0; thread: main</span></span><br></pre></td></tr></table></figure>
<h3 id="Search"><a href="#Search" class="headerlink" title="Search"></a>Search</h3><p>Search方法接受一个Bifunction，并且为当前的键值对返回一个非空结果或者null如果当前的迭代没有满足要求。只要一个非空结果返回后，更近一步的搜索操作将会停止。记住ConcurrentHashMap是无序的。这个搜索方法不应该依赖于map之前的顺序。如果有多个值都符合搜索结果，那么返回的结果是不定的。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">String result = map.search(<span class="number">1</span>, (key, value) -&gt; &#123;</span><br><span class="line">    System.out.println(Thread.currentThread().getName());</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"foo"</span>.equals(key)) &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;);</span><br><span class="line">System.out.println(<span class="string">"Result: "</span> + result);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ForkJoinPool.commonPool-worker-2</span></span><br><span class="line"><span class="comment">// main</span></span><br><span class="line"><span class="comment">// ForkJoinPool.commonPool-worker-3</span></span><br><span class="line"><span class="comment">// Result: bar</span></span><br></pre></td></tr></table></figure>
<h3 id="Reduce"><a href="#Reduce" class="headerlink" title="Reduce"></a>Reduce</h3><p>方法reduce可以接受两个类型为Bifunction的lambda表达式。第一个函数用于转换每个key-value键值为一个值。第二个函数用于将所转换的值变为一个值，忽略掉所有可能为空的值。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">String result = map.reduce(<span class="number">1</span>,</span><br><span class="line">    (key, value) -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">"Transform: "</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">return</span> key + <span class="string">"="</span> + value;</span><br><span class="line">    &#125;,</span><br><span class="line">    (s1, s2) -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">"Reduce: "</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">return</span> s1 + <span class="string">", "</span> + s2;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"Result: "</span> + result);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Transform: ForkJoinPool.commonPool-worker-2</span></span><br><span class="line"><span class="comment">// Transform: main</span></span><br><span class="line"><span class="comment">// Transform: ForkJoinPool.commonPool-worker-3</span></span><br><span class="line"><span class="comment">// Reduce: ForkJoinPool.commonPool-worker-3</span></span><br><span class="line"><span class="comment">// Transform: main</span></span><br><span class="line"><span class="comment">// Reduce: main</span></span><br><span class="line"><span class="comment">// Reduce: main</span></span><br><span class="line"><span class="comment">// Result: r2=d2, c3=p0, han=solo, foo=bar</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.sevenpan.com/2019/03/05/java/CoreJava/Java8 并发指南：同步和锁 Synchronization and Locks/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Pan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eden">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/05/java/CoreJava/Java8 并发指南：同步和锁 Synchronization and Locks/" itemprop="url">Java8 并发指南：同步和锁 Synchronization and Locks</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-05T10:44:55+08:00">
                2019-03-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Java8-并发指南：同步和锁-Synchronization-and-Locks"><a href="#Java8-并发指南：同步和锁-Synchronization-and-Locks" class="headerlink" title="Java8 并发指南：同步和锁 Synchronization and Locks"></a>Java8 并发指南：同步和锁 Synchronization and Locks</h1><p>from：<a href="https://winterbe.com/posts/2015/04/30/java8-concurrency-tutorial-synchronized-locks-examples/" target="_blank" rel="noopener">https://winterbe.com/posts/2015/04/30/java8-concurrency-tutorial-synchronized-locks-examples/</a><br>这是java8 并发指南的第二部分。在这个部分，你将会学习如何同步访问可变共享变量通过synchronized关键字，lock锁和信号semaphores。  </p>
<h2 id="synchronized同步"><a href="#synchronized同步" class="headerlink" title="synchronized同步"></a>synchronized同步</h2><p>在上一篇文章中，我们学习了如何并发执行代码通过executor服务。在编写多线程代码时，你需要格外注意多线程是如何访问可变共享变量的。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    count = count + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ExecutorService executor = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">IntStream.range(<span class="number">0</span>, <span class="number">10000</span>)</span><br><span class="line">    .forEach(i -&gt; executor.submit(<span class="keyword">this</span>::increment));</span><br><span class="line"></span><br><span class="line">stop(executor);</span><br><span class="line"></span><br><span class="line">System.out.println(count);  <span class="comment">// 9965</span></span><br></pre></td></tr></table></figure>
<p>因为我们共享了一个可变变量在不同的线程中而不加同步锁。结果是一个竞赛条件race condition(结果依赖于环境，不可固定。)。<br>为了增加数字有三个步骤：1.获取当前值。2.在这个值基础上加一。3.写入新的值到变量中。如果两个线程同时操作，并且都同时操作第一步，那么可能最后的值会比预想的值要小。<br>这个问题可以用java同步读synchronized关键字来解决。<br>内部java会使用一个监视器或者也被称为监视锁或者固有锁来管理同步。这个锁是和对象绑定的，比如当使用一个同步方法的时候，每一个方法共享相同的对象监视器。<br>所有的内部监视器实现了可重入的特性。可重入意味着锁和当前的线程绑定了。一个现场可以安全的多次获取相同的锁而不会进入死锁状态。</p>
<h2 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h2><p>除了通过synchronized来使用内部锁，并发API也支持多种实现了Lock接口的显示锁。相对于内在监视器，Locks支持多种方法来细粒度控制。<br>在标准JDK中有多种锁的实现是可用的并将会在以下展示。</p>
<h3 id="ReentrantLock-可重入锁"><a href="#ReentrantLock-可重入锁" class="headerlink" title="ReentrantLock 可重入锁"></a>ReentrantLock 可重入锁</h3><p>ReentrantLock 可重入锁是一个相互排斥的锁和内部监视器有着相同的基本行为但是有着其他扩展的能力。从名字可以看出，这个锁也是可以重入的。<br>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"><span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        count++;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>锁是通过lock()来获取的，unlock()来释放的。将你的代码使用一个try/finally来包含起来很重要。这个方法就是线程安全的。  </p>
<h3 id="ReadWriteLock-读写锁"><a href="#ReadWriteLock-读写锁" class="headerlink" title="ReadWriteLock 读写锁"></a>ReadWriteLock 读写锁</h3><p>ReadWriteLock接口指定了锁的另外一种类型来维护一对锁用于读和写访问。在读写锁的背后的想法是多个线程来读通常是安全的，只要同时没有线程在对锁进行写。所以读锁可以被同时多个线程所拥有制药没有线程有写锁。这个可以提升性能因为读会比写要更加频繁一些。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService executor = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">ReadWriteLock lock = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line"></span><br><span class="line">executor.submit(() -&gt; &#123;</span><br><span class="line">    lock.writeLock().lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        map.put(<span class="string">"foo"</span>, <span class="string">"bar"</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.writeLock().unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Runnable readTask = () -&gt; &#123;</span><br><span class="line">    lock.readLock().lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(map.get(<span class="string">"foo"</span>));</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.readLock().unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">executor.submit(readTask);</span><br><span class="line">executor.submit(readTask);</span><br><span class="line"></span><br><span class="line">stop(executor);</span><br></pre></td></tr></table></figure>
<p>当你执行代码片段时，你将会注意到所有读任务都需要等待一秒直到写任务完成。写任务完成之后，读任务会并发运行并且同时输出。  </p>
<h3 id="StampedLock"><a href="#StampedLock" class="headerlink" title="StampedLock"></a>StampedLock</h3><p>Java8有一个新的锁叫做StampedLocked同样和上一个锁一样也支持读和写。不同于读写锁的是，这个StampedLock方法会返回一个戳的整形值。你可以使用这些戳来释放一个锁或者检查这个锁是否仍然合法。另外stamped locks 支持一种锁的模式叫做optimistic locking。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService executor = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">StampedLock lock = <span class="keyword">new</span> StampedLock();</span><br><span class="line"></span><br><span class="line">executor.submit(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">long</span> stamp = lock.writeLock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        map.put(<span class="string">"foo"</span>, <span class="string">"bar"</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlockWrite(stamp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Runnable readTask = () -&gt; &#123;</span><br><span class="line">    <span class="keyword">long</span> stamp = lock.readLock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(map.get(<span class="string">"foo"</span>));</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlockRead(stamp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">executor.submit(readTask);</span><br><span class="line">executor.submit(readTask);</span><br><span class="line"></span><br><span class="line">stop(executor);</span><br></pre></td></tr></table></figure>
<p>通过readLock()，writeLock()来返回一个stamp并且之后用这个stamp来释放锁。需要记住的是，stamped Locks没有实现可重入的特性。每次调用锁都会返回一个新的stamp并且如果没有锁将会阻塞即使在同一个线程中已经持有锁了。所以你特别需要注意不要死锁。<br>就和前文所说的ReawriteLock例子一样，所有的读任务都要等待写任务完成，而读任务可以并发。<br>下面这个例子展示了乐观锁：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService executor = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">StampedLock lock = <span class="keyword">new</span> StampedLock();</span><br><span class="line"></span><br><span class="line">executor.submit(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">long</span> stamp = lock.tryOptimisticRead();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"Optimistic Lock Valid: "</span> + lock.validate(stamp));</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        System.out.println(<span class="string">"Optimistic Lock Valid: "</span> + lock.validate(stamp));</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        System.out.println(<span class="string">"Optimistic Lock Valid: "</span> + lock.validate(stamp));</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock(stamp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">executor.submit(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">long</span> stamp = lock.writeLock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"Write Lock acquired"</span>);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock(stamp);</span><br><span class="line">        System.out.println(<span class="string">"Write done"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">stop(executor);</span><br></pre></td></tr></table></figure>
<p>和一般的读锁不同的是乐观锁并不阻止其他线程来即刻获取写锁。在第一个线程sleep后第二个线程获取了写锁而不需要等待乐观锁的释放。从这一刻开始，乐观锁将不再合法，即使是写锁已经被释放了以后。<em>所以当你使用乐观锁的是，你每次读完可变变量后都需要校验读锁是否合法</em>。<br>有时将一个读锁转换为写锁而无需使用unlocking和locking是很方便的事情。StampedLock提供tryConvertToWriteLock()的方法来达到这个目的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService executor = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">StampedLock lock = <span class="keyword">new</span> StampedLock();</span><br><span class="line"></span><br><span class="line">executor.submit(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">long</span> stamp = lock.readLock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">            stamp = lock.tryConvertToWriteLock(stamp);</span><br><span class="line">            <span class="keyword">if</span> (stamp == <span class="number">0L</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">"Could not convert to write lock"</span>);</span><br><span class="line">                stamp = lock.writeLock();</span><br><span class="line">            &#125;</span><br><span class="line">            count = <span class="number">23</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(count);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock(stamp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">stop(executor);</span><br></pre></td></tr></table></figure>
<p>调用tryConvertToWriteLock()就不会阻塞，但是可能返回0代表现在没有写锁可用，这个时候代码需要使用writeLock()来阻塞当前的线程直到有写锁可用。  </p>
<h2 id="Semaphores-信号"><a href="#Semaphores-信号" class="headerlink" title="Semaphores 信号"></a>Semaphores 信号</h2><p>除了锁，并发API也支持计数信号。锁事用来获取高端的变量或者资源的访问而信号是用来维护一套权限的。当你需要限制当前的并发访问的时候很有用。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService executor = Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">Runnable longRunningTask = () -&gt; &#123;</span><br><span class="line">    <span class="keyword">boolean</span> permit = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        permit = semaphore.tryAcquire(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">if</span> (permit) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Semaphore acquired"</span>);</span><br><span class="line">            sleep(<span class="number">5</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"Could not acquire semaphore"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (permit) &#123;</span><br><span class="line">            semaphore.release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">IntStream.range(<span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line">    .forEach(i -&gt; executor.submit(longRunningTask));</span><br><span class="line"></span><br><span class="line">stop(executor);</span><br></pre></td></tr></table></figure>
<p>这个executor可以同时运行10个任务但是我们使用大小为5的信号量来限制并发数量为5.特别重要的是要使用try/finally来合适的释放信号如果有异常发生的时候。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.sevenpan.com/2019/03/04/java/CoreJava/Java8 并发指南：线程和执行者 Threads and Executors/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Pan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eden">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/04/java/CoreJava/Java8 并发指南：线程和执行者 Threads and Executors/" itemprop="url">Java8 并发指南：线程和执行者 Threads and Executors</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-04T15:12:25+08:00">
                2019-03-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Java8-并发指南：线程和执行者-Threads-and-Executors"><a href="#Java8-并发指南：线程和执行者-Threads-and-Executors" class="headerlink" title="Java8 并发指南：线程和执行者 Threads and Executors"></a>Java8 并发指南：线程和执行者 Threads and Executors</h1><p>from： <a href="https://winterbe.com/posts/2015/04/07/java8-concurrency-tutorial-thread-executor-examples/" target="_blank" rel="noopener">https://winterbe.com/posts/2015/04/07/java8-concurrency-tutorial-thread-executor-examples/</a><br>这个指南主要是教你理解Java8并发编程。一共有三个部分：  </p>
<ol>
<li>线程和执行(Threads and Executors)</li>
<li>同步和锁(Synchronization and Locks)</li>
<li>原子变量和并发map(Atomic Variables and ConcurrentMap)<br>并发编程的API最开始是在JAVA5中被介绍的，之后就不断的逐渐被增强。本文中的主要观点也可以在老java版本中工作。不过代码主要集中在Java8并且使用了lambda表达和其他的一些新特性。如果对lambda不太熟悉可以先阅读<a href="https://winterbe.com/posts/2014/03/16/java-8-tutorial/" target="_blank" rel="noopener">https://winterbe.com/posts/2014/03/16/java-8-tutorial/</a>这篇文章。  </li>
</ol>
<h2 id="Threads-和-Runables"><a href="#Threads-和-Runables" class="headerlink" title="Threads 和 Runables"></a>Threads 和 Runables</h2><p>所有的现代操作系统都是通过线程和进程来支持高并发的。进程是程序的实例通常是独立运行的。而线程是用来并发执行程序的，这样我们可以最大程度的利用CPU。<br>Java从JDK1.0开始支持线程。</p>
<h2 id="Executors"><a href="#Executors" class="headerlink" title="Executors"></a>Executors</h2><p>并发的API介绍了一个ExecutorService的概念作为一个高层级的替代来和Threads直接进行工作。Executors可以运行匿名方法和管理一个线程池，所以我们无须手动创造线程。在线程池中的所有线程将会被通过钩子函数来复用，所以我们可以运行任意多的并发任务在我们的应用的生命周期中通过一个executor服务。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService executor = Executors.newSingleThreadExecutor();</span><br><span class="line">executor.submit(() -&gt; &#123;</span><br><span class="line">    String threadName = Thread.currentThread().getName();</span><br><span class="line">    System.out.println(<span class="string">"Hello "</span> + threadName);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>看起来运行的和之前的Threads和Runables结果差不多，但是在这个例子中，这个Java进程从来不会停止。Executors需要被显示的停止，否则她们将会继续监听新的线程。<br>一个ExecutorService提供两个方法来关闭：shutdown()等待当前任务执行结束，然后停止。shutdownNow()终止所有运行的任务，并且立刻停止executor。<br>通常用来停止线程池的方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">"attempt to shutdown executor"</span>);</span><br><span class="line">    executor.shutdown();</span><br><span class="line">    executor.awaitTermination(<span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    System.err.println(<span class="string">"tasks interrupted"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!executor.isTerminated()) &#123;</span><br><span class="line">        System.err.println(<span class="string">"cancel non-finished tasks"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    executor.shutdownNow();</span><br><span class="line">    System.out.println(<span class="string">"shutdown finished"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Callables-和-Futures"><a href="#Callables-和-Futures" class="headerlink" title="Callables 和 Futures"></a>Callables 和 Futures</h2><p>除了Runnable，executors也支持另外一种类型任务：Callable。Callable是和Runnable一样的函数接口，但是函数返回值不是空值。<br>Callable可以提交给线程池就像是Runnable一样。但是submit()并不会等待任务的完成，executor并不能直接返回callable的结果。Future替换了executor来获取真实的返回值在之后的时间点。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService executor = Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">Future&lt;Integer&gt; future = executor.submit(task);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"future done? "</span> + future.isDone());</span><br><span class="line"></span><br><span class="line">Integer result = future.get();</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"future done? "</span> + future.isDone());</span><br><span class="line">System.out.print(<span class="string">"result: "</span> + result);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">future done? false</span><br><span class="line">future done? true</span><br><span class="line">result: 123</span><br></pre></td></tr></table></figure>
<p>Futures和底层的线程池服务是耦合的。如果在future还没运行完毕的时候，你关闭了线程池，将会有异常抛出。  </p>
<h2 id="Timeouts"><a href="#Timeouts" class="headerlink" title="Timeouts"></a>Timeouts</h2><p>调用future.get()时，会阻塞线程直到返回，也可以在get上加timeout的参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService executor = Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">Future&lt;Integer&gt; future = executor.submit(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">123</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"task interrupted"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">future.get(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">```	</span><br><span class="line"></span><br><span class="line">## InvokeAll</span><br><span class="line">Executor支持一次批量提交多个callables通过invokeAll()。这个方法接受了一个callable的集合并且放回futures的list。  </span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">ExecutorService executor = Executors.newWorkStealingPool();</span><br><span class="line"></span><br><span class="line">List&lt;Callable&lt;String&gt;&gt; callables = Arrays.asList(</span><br><span class="line">        () -&gt; <span class="string">"task1"</span>,</span><br><span class="line">        () -&gt; <span class="string">"task2"</span>,</span><br><span class="line">        () -&gt; <span class="string">"task3"</span>);</span><br><span class="line"></span><br><span class="line">executor.invokeAll(callables)</span><br><span class="line">    .stream()</span><br><span class="line">    .map(future -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> future.get();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .forEach(System.out::println);</span><br></pre></td></tr></table></figure>
<h2 id="InvokeAny"><a href="#InvokeAny" class="headerlink" title="InvokeAny"></a>InvokeAny</h2><p>另外一种批量提交callable的方式是invokeAny()，工作的方式和invokeAll有所不同。不同于返回future对象，这个方法在第一次调用终止前会阻塞并且放回callable的结果。<br>为了测试这个行为，代码如下，这个方法在返回值之前会睡眠一段时间，然后我们使用一系列的不同返回时间的callable并且通过invokeAny()进行调用。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Callable&lt;String&gt; <span class="title">callable</span><span class="params">(String result, <span class="keyword">long</span> sleepSeconds)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> () -&gt; &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(sleepSeconds);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ExecutorService executor = Executors.newWorkStealingPool();</span><br><span class="line"></span><br><span class="line">List&lt;Callable&lt;String&gt;&gt; callables = Arrays.asList(</span><br><span class="line">    callable(<span class="string">"task1"</span>, <span class="number">2</span>),</span><br><span class="line">    callable(<span class="string">"task2"</span>, <span class="number">1</span>),</span><br><span class="line">    callable(<span class="string">"task3"</span>, <span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">String result = executor.invokeAny(callables);</span><br><span class="line">System.out.println(result);</span><br></pre></td></tr></table></figure>
<p>上述代码中使用了另外一种executor叫做newWorkStealingPool，这个工厂方法是Java8中的一种，并且返回一种ForkJoinPool的executor。不同于使用的是固定大小的线程池，ForkJoinPools被创建给一个和当前hostsCPU数量相同的数量的线程池。  </p>
<h2 id="Scheduled-Executors"><a href="#Scheduled-Executors" class="headerlink" title="Scheduled Executors"></a>Scheduled Executors</h2><p>在学会了如何通过executor一次提交并且运行任务，为了可以周期性的多次运行任务，我们可以利用计划的线程池。<br>一个ScheduledExecutorService是一种可以计划任务来运行不管是周期性的还是只是运行一次。  </p>
<p>如下代码是在三秒延迟之后运行任务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ScheduledExecutorService executor = Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">Runnable task = () -&gt; System.out.println(<span class="string">"Scheduling: "</span> + System.nanoTime());</span><br><span class="line">ScheduledFuture&lt;?&gt; future = executor.schedule(task, <span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">TimeUnit.MILLISECONDS.sleep(<span class="number">1337</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> remainingDelay = future.getDelay(TimeUnit.MILLISECONDS);</span><br><span class="line">System.out.printf(<span class="string">"Remaining Delay: %sms"</span>, remainingDelay);</span><br></pre></td></tr></table></figure>
<p>ScheduledFuture有一个方法getDelay()来获取剩下的延迟时间。直到延迟结束，这个任务将会被并发。<br>为了让任务可以周期性执行，executors提供了两个方法：scheduleAtFixedRate(), scheduleWithFixedDelay()。FixedRate是不考虑任务运行时间的，比如如果间隔是1s而任务要运行2s那么这个任务会很快不断运行。而FixedDelay则是考虑的是任务结束和下一个任务开始之间的间隔的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ScheduledExecutorService executor = Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">Runnable task = () -&gt; System.out.println(<span class="string">"Scheduling: "</span> + System.nanoTime());</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> initialDelay = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> period = <span class="number">1</span>;</span><br><span class="line">executor.scheduleAtFixedRate(task, initialDelay, period, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">ScheduledExecutorService executor = Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">Runnable task = () -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        System.out.println(<span class="string">"Scheduling: "</span> + System.nanoTime());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        System.err.println(<span class="string">"task interrupted"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">executor.scheduleWithFixedDelay(task, <span class="number">0</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.sevenpan.com/2019/03/03/java/Spring/Spring 学习-- IOC容器和Dependency Injection 模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Pan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eden">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/03/java/Spring/Spring 学习-- IOC容器和Dependency Injection 模式/" itemprop="url">Spring 学习-- IOC容器和Dependency Injection 模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-03T22:41:46+08:00">
                2019-03-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Spring-学习–-IOC容器和Dependency-Injection-模式"><a href="#Spring-学习–-IOC容器和Dependency-Injection-模式" class="headerlink" title="Spring 学习– IOC容器和Dependency Injection 模式"></a>Spring 学习– IOC容器和Dependency Injection 模式</h1><p>from:<a href="http://insights.thoughtworkers.org/injection/" target="_blank" rel="noopener">http://insights.thoughtworkers.org/injection/</a></p>
<h2 id="组件和服务"><a href="#组件和服务" class="headerlink" title="组件和服务"></a>组件和服务</h2><p>服务(service)：可以看作是需要通过远程接口来远程调用的(例如web Service，消息系统，RPC或者socket)。<br>组件（component）：本地使用的（例如JAR文件，程序集，DLL或者源码导入）。  </p>
<h2 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MovieLister</span>...</span></span><br><span class="line"><span class="class"></span></span><br><span class="line">    public Movie[] moviesDirectedBy(String arg)</span><br><span class="line">    &#123;</span><br><span class="line">        List allMovies = finder.findAll();</span><br><span class="line">        <span class="keyword">for</span> (Iterator it = allMovies.iterator(); it.hasNext();)</span><br><span class="line">        &#123;</span><br><span class="line">            Movie movie = (Movie) it.next();</span><br><span class="line">            <span class="keyword">if</span> (!movie.getDirector().equals(arg))</span><br><span class="line">            &#123;</span><br><span class="line">                it.remove();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (Movie[]) allMovies.toArray(<span class="keyword">new</span> Movie[allMovies.size()]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在MovieLister中有一个finder对象，用于搜寻全部的电影。目的是上面的moviesDirectedBy方法不依赖于电影的存储方式而可以运行。比如定义了接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MovieFinder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function">List <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和一个具体的实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MovieLister</span>...</span></span><br><span class="line"><span class="class">    <span class="title">private</span> <span class="title">MovieFinder</span> <span class="title">finder</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MovieLister</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        finder = <span class="keyword">new</span> ColonDelimitedMovieFinder(<span class="string">"movies1.txt"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>上面这个实现类就是从一个存储着电影名字的文件中来获取电影。但是如果其他的人也想要使用这个程序，但是存储电影的形式并不是在文件中，而是在SQL，XML文件或者web Service中，应该怎么办？<br>我们希望MovieLister可以和MovieFinder的任何实现类一起配合工作，并且允许在运行期插入具体的实现类。而这里用到的就是<strong>控制反转(Inversion of Control)</strong>。  </p>
<h2 id="控制反转"><a href="#控制反转" class="headerlink" title="控制反转"></a>控制反转</h2><p>反转了哪方面的控制？比如有的是针对用户界面的主控权。早期的用户界面是由应用程序来控制的。而后来界面环境下，UI框架负责执行一个主循环，应用程序只需要为屏幕的各个区域提供事件处理函数就可以了。这里<strong>控制权从应用程序移到了框架</strong>。<br>而这些新生的容器框架，反转的是如何定位插件的具体实现。在前面例子中，MovieLister负责定位MovieFinder的具体实现– 它直接实例化后者的一个子类。这样MovieFinder没法作为一个插件，因为它并不是在运行期插入程序的。而轻量级容器提供了更加灵活的方式，只要遵循一定的规则，一个独立的组装模块就可以将插件的具体实现注射到应用程序中。这种模式称为“依赖注入Dependency Injection”。  </p>
<h2 id="依赖注入的几种形式"><a href="#依赖注入的几种形式" class="headerlink" title="依赖注入的几种形式"></a>依赖注入的几种形式</h2><p>基本思想：用一个单独的装配器来获取对应的合适的实现，并将其实例赋给MovieLister类的一个字段。<br>依赖注入有三种形式：1.构造函数注入(Constructor Injection) 2. 设值方法注入(Setter Injection) 3.接口注入(Interface Injection)<br>这三种分别就是 指注入的形式，</p>
<h3 id="构造函数注入"><a href="#构造函数注入" class="headerlink" title="构造函数注入"></a>构造函数注入</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MovieLister</span>...</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">MovieLister</span>(<span class="title">MovieFinder</span> <span class="title">finder</span>)</span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.finder = finder;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>构造函数中将实现注入。 </p>
<h3 id="设值方法注入"><a href="#设值方法注入" class="headerlink" title="设值方法注入"></a>设值方法注入</h3><p>就是用专门的set方法来注入实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MovieLister</span>...</span></span><br><span class="line"><span class="class">    <span class="title">private</span> <span class="title">MovieFinder</span> <span class="title">finder</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFinder</span><span class="params">(MovieFinder finder)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.finder = finder;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ColonMovieFinder</span>...</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">void</span> <span class="title">setFilename</span>(<span class="title">String</span> <span class="title">filename</span>)</span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.filename = filename;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>然后在配置文件中具体指出配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"MovieLister"</span> <span class="attr">class</span>=<span class="string">"spring.MovieLister"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"finder"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">local</span>=<span class="string">"MovieFinder"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"MovieFinder"</span> <span class="attr">class</span>=<span class="string">"spring.ColonMovieFinder"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"filename"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>movies1.txt<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="接口注入"><a href="#接口注入" class="headerlink" title="接口注入"></a>接口注入</h3><p>先定义一个接口，然后组件通过这个接口进行注入。比如，下面代码中，接口InjectFinder的用途就是将一个MovieFinder实例注入继承该接口的对象。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InjectFinder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">injectFinder</span><span class="params">(MovieFinder finder)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个接口由提供MovieFinder接口的人一并提供，任何想要实现MovieFinder实例的类，如MovieLister类都必须实现这个接口。这样以来就必须在运行时指定具体实现类了。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MovieLister</span> <span class="keyword">implements</span> <span class="title">InjectFinder</span>...</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">void</span> <span class="title">injectFinder</span>(<span class="title">MovieFinder</span> <span class="title">finder</span>)</span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.finder = finder;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>然后使用类似的方法将文件名注入MovieFinder的实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InjectFilename</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">injectFilename</span> <span class="params">(String filename)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ColonMovieFinder</span> <span class="keyword">implements</span> <span class="title">MovieFinder</span>, <span class="title">InjectFilename</span>...</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">void</span> <span class="title">injectFilename</span>(<span class="title">String</span> <span class="title">filename</span>)</span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.filename = filename;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>最后，对所有组件进行装配：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IfaceTester</span>...</span></span><br><span class="line"><span class="class">    <span class="title">private</span> <span class="title">MovieLister</span> <span class="title">lister</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureLister</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ColonMovieFinder finder = <span class="keyword">new</span> ColonMovieFinder();</span><br><span class="line">        finder.injectFilename(<span class="string">"movies1.txt"</span>);</span><br><span class="line">        lister = <span class="keyword">new</span> MovieLister();</span><br><span class="line">        lister.injectFinder(finder);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>比如这上面，configureLister()就将具体实现通过这个接口进行了注入。  </p>
<h2 id="使用Service-Locator-服务定位？"><a href="#使用Service-Locator-服务定位？" class="headerlink" title="使用Service Locator(服务定位？)"></a>使用Service Locator(服务定位？)</h2><p>依赖注入最大的好处在于：它消除了MovieLister类对具体MovieFinder实现类的依赖。这样不同的环境可以插入合适的MovieFinder实现。而Service Locator也可以打破这层依赖。<br>Service Locator背后的思想是：有一个对象(服务定位器)可以知道如何获取一个应用程序所需的所有服务。</p>
<p><img src="DI_injection-image-3.gif" alt="DI_injection-image-3.gif"></p>
<p>将ServiceLocator实现为一个Singleton的注册表，MovieLister就可以在实例化时通过ServiceLocator获得一个MovieFinder的实例。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MovieLister</span>...</span></span><br><span class="line"><span class="class">    <span class="title">MovieFinder</span> <span class="title">finder</span> </span>= ServiceLocator.movieFinder();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceLocator</span>...</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">static</span> <span class="title">MovieFinder</span> <span class="title">movieFinder</span>()</span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> soleInstance.movieFinder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ServiceLocator soleInstance;</span><br><span class="line">    <span class="keyword">private</span> MovieFinder movieFinder;</span><br></pre></td></tr></table></figure>
<p>配置的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tester</span>...</span></span><br><span class="line"><span class="class">    <span class="title">private</span> <span class="title">void</span> <span class="title">configure</span>()</span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        ServiceLocator.load(<span class="keyword">new</span> ServiceLocator(</span><br><span class="line">        newColonMovieFinder(<span class="string">"movies1.txt"</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceLocator</span>...</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">static</span> <span class="title">void</span> <span class="title">load</span>(<span class="title">ServiceLocator</span> <span class="title">arg</span>)</span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        soleInstance = arg;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceLocator</span><span class="params">(MovieFinder movieFinder)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.movieFinder = movieFinder;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="为定位器提供分离的接口"><a href="#为定位器提供分离的接口" class="headerlink" title="为定位器提供分离的接口"></a>为定位器提供分离的接口</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.sevenpan.com/2019/02/03/基础建设和杂项比较/DevOps 笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Pan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eden">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/03/基础建设和杂项比较/DevOps 笔记/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-03T15:43:16+08:00">
                2019-02-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="DevOps"><a href="#DevOps" class="headerlink" title="DevOps"></a>DevOps</h1><p>找了一个关于devops的文章，想看看详细的实践是怎么做的。<br>from: <a href="https://medium.com/@devfire" target="_blank" rel="noopener">https://medium.com/@devfire</a><br> <a href="https://medium.com/@devfire/how-to-become-a-devops-engineer-in-six-months-or-less-part-2-configure-a2dfc11f6f7d" target="_blank" rel="noopener">https://medium.com/@devfire/how-to-become-a-devops-engineer-in-six-months-or-less-part-2-configure-a2dfc11f6f7d</a></p>
<h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><p><a href="https://medium.com/@devfire/how-to-become-a-devops-engineer-in-six-months-or-less-366097df7737" target="_blank" rel="noopener">https://medium.com/@devfire/how-to-become-a-devops-engineer-in-six-months-or-less-366097df7737</a><br>基础列的就是三部分:Linux, Python 以及 AWS.<br>然后六个部分：  </p>
<pre><code>configure配置：Terraform - Ansible
Version版本：Git+GitHub - GitLab
package包:Docker - Lambda
Deploy部署:Jenkins - codeDeploy 
Run运行:ECS - Kubernetes
Monitoer监控：ELK Stack - Prometheus
</code></pre><h2 id="configure-配置"><a href="#configure-配置" class="headerlink" title="configure 配置"></a>configure 配置</h2><p><a href="https://medium.com/@devfire/how-to-become-a-devops-engineer-in-six-months-or-less-part-2-configure-a2dfc11f6f7d" target="_blank" rel="noopener">https://medium.com/@devfire/how-to-become-a-devops-engineer-in-six-months-or-less-part-2-configure-a2dfc11f6f7d</a><br>配置就是将机器配置好基础设施来让代码运行。以前的话可能是一步一步的安装，而新的方法是将基础设施也编码(infrastructure-as-code).这也是这个阶段需要做的事情。<br><em>作为最佳实践，基础设施作为代码要求提供计算资源所需的任何工作都必须通过代码来完成。</em><br>计算资源是指：计算，存储，网络，数据库等等。<br>在Devops中，我们将会：</p>
<ol>
<li>在<a href="https://www.terraform.io/" target="_blank" rel="noopener">Terraform</a>中填写我们需要的设施</li>
<li>将它保存在我们源代码管理中</li>
<li>通过一个PR来获取反馈</li>
<li>测试</li>
<li>执行用来提供所有需要的资源。</li>
</ol>
<p><img src="TerraformAndAnsible.png" alt="TerraformAndAnsible"><br>同时Ansible可能后面会慢慢淘汰，因为 immutable deployments的推行。所有的环境配置都是一致的无需改变的。<br>怎么开始： Terraform+AWS 套餐可以看下。  </p>
<h2 id="版本version"><a href="#版本version" class="headerlink" title="版本version"></a>版本version</h2><p>使用git进行版本控制。<br>最少你应该精通以下：</p>
<ol>
<li>Fork一个仓库</li>
<li>创建分支</li>
<li>从upstream中合并改变，并且回来</li>
<li>创建一个Pull Requests。</li>
</ol>
<h2 id="打包-Package"><a href="#打包-Package" class="headerlink" title="打包 Package"></a>打包 Package</h2><p><a href="https://medium.com/@devfire/how-to-become-a-devops-engineer-in-six-months-or-less-part-4-package-47677ca2f058" target="_blank" rel="noopener">https://medium.com/@devfire/how-to-become-a-devops-engineer-in-six-months-or-less-part-4-package-47677ca2f058</a><br>虚拟化技术可以节省等待时间并且更快部署。  </p>
<h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><p>Docker就是基于一个很久以前的想法：在同样的操作系统中对每个单独的进程进行隔离。这不是’full virtualization’:在同一物理主机上并行运行虚拟机。<br>Docker 是和微服务同步兴起的，它可以解决不同的app有环境冲突的问题。比如python，java应用需要的环境配置都是不一样的。  </p>
<h3 id="Lambda"><a href="#Lambda" class="headerlink" title="Lambda"></a>Lambda</h3><p>运行Docker仍然是运行服务器，服务器都是易碎，脆弱的。他们都需要被管理，打补丁等等。<br>同时Docker并不是100%安全的。运行容器托管的大公司都是在虚拟机中进行的而不是在裸机上运行，这样可以获得虚拟机的安全性和容器的快速。<br>最后，没有人只是运行Docker。大部分都是将它作为一个复杂容器编排结构的一部分。<br>AWS lambda允许您在不设置或管理服务器的情况下运行代码。您只需支付您所花费的计算时间-当您的代码没有运行时，不收取任何费用。<br>这尼玛是广告吧。。。<br>但是这个环境怎么实现的？？可以看看。。serverless嘛。。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.sevenpan.com/2019/01/22/基础建设和杂项比较/一台VPS所需要的安装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Pan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eden">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/22/基础建设和杂项比较/一台VPS所需要的安装/" itemprop="url">一台VPS所需要的操作</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-22T16:20:00+08:00">
                2019-01-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一台VPS所需要的操作"><a href="#一台VPS所需要的操作" class="headerlink" title="一台VPS所需要的操作"></a>一台VPS所需要的操作</h2><p>又弄了一台VPS，记录下我需要的下载的工具作为一个列表。免得每次都没啥头绪。</p>
<ol>
<li><a href="###创建自己的用户">创建自己的用户</a></li>
<li><a href="###创建SSH以及无密码登陆">创建SSH以及无密码登陆</a></li>
<li><a href="###安装FTP服务器">安装FTP服务器</a></li>
<li><a href="###firewall建立防火墙">firewall 建立防火墙</a></li>
<li><a href="###安装Python，git以及Shadowsock">安装Python，git以及Shadowsock</a></li>
<li><a href="###将自己的个人博客转到这个服务器上">将自己的个人博客转到这个服务器上</a></li>
<li>安装Python，Java，Docker，git, PGSQL…</li>
</ol>
<h3 id="创建自己的用户"><a href="#创建自己的用户" class="headerlink" title="创建自己的用户"></a>创建自己的用户</h3><p><a href="https://www.digitalocean.com/community/tutorials/how-to-create-a-sudo-user-on-centos-quickstart" target="_blank" rel="noopener">https://www.digitalocean.com/community/tutorials/how-to-create-a-sudo-user-on-centos-quickstart</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">adduser -p password -Um user</span><br><span class="line">#检查用户是否创建成功</span><br><span class="line">id user</span><br><span class="line">&gt;uid=500(user) gid=500(user) groups=500(user)</span><br><span class="line"># 添加它到root和wheel组</span><br><span class="line">usermod -aG wheel user</span><br><span class="line">usermod -aG root user</span><br><span class="line"># 运行sudo操作</span><br><span class="line">more sudoers</span><br><span class="line">visudoers</span><br><span class="line">#将其中的	# 这里注释掉就好了。</span><br><span class="line">## Allows people in group wheel to run all commands</span><br><span class="line"># %wheel	ALL=(ALL)	ALL</span><br></pre></td></tr></table></figure>
<p>git 用户：</p>
<pre><code>sudo adduser git
su git
cd
mkdir .ssh &amp;&amp; chmod 700 .ssh
touch .ssh/authorized_keys &amp;&amp; chmod 600 .ssh/authorized_keys
</code></pre><h3 id="创建SSH-以及无密码登陆"><a href="#创建SSH-以及无密码登陆" class="headerlink" title="创建SSH 以及无密码登陆"></a>创建SSH 以及无密码登陆</h3><p>搬瓦工自带了ssh，我配置下无须密码输入的登陆就好了，修改本机的.bash_profiles：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">	ssh user@ip -p port mkdir -p .ssh</span><br><span class="line">	cat .ssh/id_rsa.pub | ssh  user@ip -p port &apos;cat &gt;&gt; .ssh/authorized_keys&apos;</span><br><span class="line">```	</span><br><span class="line"></span><br><span class="line">结果这般操作后还是不能无密码登陆，还有一些东西需要确认。</span><br></pre></td></tr></table></figure>
<pre><code>chmod 750 ~  
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">以及ssh的配置文件中的：</span><br><span class="line">/etc/ssh/sshd_config  </span><br><span class="line">	</span><br><span class="line">	RSAAuthentication yes</span><br><span class="line">	PubkeyAuthentication yes</span><br><span class="line"></span><br><span class="line">需要解开注释。  </span><br><span class="line"></span><br><span class="line">### 安装FTP服务器</span><br><span class="line"></span><br><span class="line">[https://www.unixmen.com/install-configure-ftp-server-centos-7/](https://www.unixmen.com/install-configure-ftp-server-centos-7/)  </span><br><span class="line">在centos上安装ftp</span><br><span class="line">	</span><br><span class="line">	yum install vsftpd ftp -y</span><br><span class="line"></span><br><span class="line">编辑修改/etc/vsftpd/vsftpd.conf文件：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	 [...]</span><br><span class="line">	## Disable anonymous login ##</span><br><span class="line">	anonymous_enable=NO</span><br><span class="line">	</span><br><span class="line">	## Uncomment ##</span><br><span class="line">	ascii_upload_enable=YES</span><br><span class="line">	ascii_download_enable=YES</span><br><span class="line">	</span><br><span class="line">	## Uncomment - Enter your Welcome message - This is optional ##</span><br><span class="line">	ftpd_banner=Welcome to UNIXMEN FTP service.</span><br><span class="line">	</span><br><span class="line">	## Add at the end of this  file ##</span><br><span class="line">	use_localtime=YES	</span><br><span class="line">运行并且开启vsftpd命令：</span><br><span class="line"></span><br><span class="line">	systemctl enable vsftpd</span><br><span class="line">	systemctl start vsftpd</span><br><span class="line"></span><br><span class="line">创建ftp用户：</span><br><span class="line">	</span><br><span class="line">	useradd ftpuser</span><br><span class="line">	passwd ftpuser</span><br><span class="line"></span><br><span class="line">连接ftp用户：</span><br><span class="line"></span><br><span class="line">	ftp ftpuser@192.168.1.101	</span><br><span class="line">	</span><br><span class="line">### firewall建立防火墙</span><br><span class="line"></span><br><span class="line">[https://www.linode.com/docs/security/firewalls/introduction-to-firewalld-on-centos/](https://www.linode.com/docs/security/firewalls/introduction-to-firewalld-on-centos/)</span><br><span class="line">FirewallD 是iptables的前端控制器用来实现网络交通规则。和iptables相比有两个不同：</span><br><span class="line">	</span><br><span class="line">	1. FirewallD 使用 zones 和services 而不是chain和rules</span><br><span class="line">	2. 它动态的管理规则，运行在不破坏当前sessions和链接的情况下升级。</span><br><span class="line"></span><br><span class="line">*FirewallD是一个iptables的wrapper来更加简单的管理iptables的规则。它不是iptables的替代品。所以iptables命令仍然可以在FirewallD上使用，但是只推荐在FirewallD上运行FirewallD的命令。*</span><br><span class="line"></span><br><span class="line">#### 在Firewalld中基本的观点</span><br><span class="line"></span><br><span class="line">##### Zones 区</span><br><span class="line"></span><br><span class="line">firewalld后台进程管理规则组称为 zones。 Zones基本上是一个规则集合支配交通应该被允许基于你相信的网络的信任级别。网络接口被分配一个区域用来治理防火墙允许的行为。    </span><br><span class="line">对于需要移动频繁的电脑，这类灵活性提供了一个很行的方式来根据网络修改你的规则。你也许有严格的规则组织大部分的网络当在一个公共WIFI网络上，当在家庭网络时会有比较宽松的限制。对于一个服务器这些区并不是特别重要，因为服务器的网络不常改变。  </span><br><span class="line">无视你的网络环境有多动态，熟悉预设区域背后的规则也会有帮助。  </span><br><span class="line">从不信任到最信任，在firewalld中预设区如下：  </span><br><span class="line"></span><br><span class="line">1. drop: 对低级别信任。所有的连接将会被丢掉并不会回复并且只有出去的网络是允许的。</span><br><span class="line">2. block:同上，但是除了简单的丢弃连接，进来的请求将会收到icmp-host-prohibited or icmp6-adm-prohibited的拒绝信息。</span><br><span class="line">3. public公共：代表公共，不信任的网络。你也许不信任其他的电脑，但是也许会允许满足一定条件的连接。</span><br><span class="line">4. external外部的：在这个情况下你使用firewall作为你的网关。这个是用来配置NAT伪装这样你的内部网络可以保存私密同时可达。</span><br><span class="line">5. internal内部的：外部区的反面，用来作为内部网关的一部分。这里的电脑是可以信任的并且一些另外的服务是可以使用的。</span><br><span class="line">6. dmz:用于给位于DMZ的计算机(对计算器进行隔离使其不能访问你的网络其他的部分)。只有确定的请求才能被允许。 </span><br><span class="line">7. work:工作的计算器。信任这个网络中的大部分计算器。可能会允许更多的服务。</span><br><span class="line">8. home:一个家庭网络。通常它中是大部分你信任的机器并且大部分的服务将会被接受。</span><br><span class="line">9. trusted：信任这个网络中的所有的机器。最开放的可用选项，应谨慎使用。</span><br><span class="line"></span><br><span class="line">##### Rule Permanence 规则的持久性</span><br><span class="line"></span><br><span class="line">在firewalld中，规程可以是持久的或者是暂时的。如果一个规则是被添加或者修改的，默认的，当前运行的防火墙的行为将会改变。在下一次启动的时候，旧的规则将会被reverted。  </span><br><span class="line">大部分的firewall-cmd选项可以允许 --permanent 标志来指示应针对非临时防火墙。这个将会影响重载的规则。这意味着你可以测试规则在你活跃的防火墙实例中，并且如果有任何问题可以进行重载。随着时间你可以使用--permanent标识来构建一个完整的规则。</span><br><span class="line"></span><br><span class="line">#### 安装并且启动防火墙	</span><br><span class="line"></span><br><span class="line">```term</span><br><span class="line">sudo yum install firewalld</span><br><span class="line">sudo systemctl enable firewalld</span><br><span class="line">sudo reboot</span><br><span class="line">sudo firewall-cmd --state</span><br></pre></td></tr></table></figure>
<p><em>重启以后，防火墙就启动了，这个时候，所有都连不进去了，所以。。再重新登录控制面板来操作吧。</em><br>一些命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --get-default-zone</span><br><span class="line">output</span><br><span class="line">public</span><br><span class="line">firewall-cmd --get-active-zones</span><br><span class="line">output</span><br><span class="line">public</span><br><span class="line">  interfaces: eth0</span><br><span class="line">firewall-cmd --list-all</span><br><span class="line">output</span><br><span class="line">public (default, active)</span><br><span class="line">  target: default</span><br><span class="line">  icmp-block-inversion: no</span><br><span class="line">  interfaces: eth0 eth1</span><br><span class="line">  sources: </span><br><span class="line">  services: ssh dhcpv6-client</span><br><span class="line">  ports: </span><br><span class="line">  protocols: </span><br><span class="line">  masquerade: no</span><br><span class="line">  forward-ports: </span><br><span class="line">  source-ports: </span><br><span class="line">  icmp-blocks: </span><br><span class="line">  rich rules: </span><br><span class="line">firewall-cmd --get-zones</span><br></pre></td></tr></table></figure>
<p>我主要运行的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --list-all</span><br><span class="line">firewall-cmd --zone=public --permanent --add-service=http</span><br><span class="line">firewall-cmd --zone=public --permanent --add-service=ssh</span><br><span class="line">firewall-cmd --zone=public --permanent --add-service=https</span><br><span class="line">firewall-cmd --zone=public --permanent --add-service=ftp  </span><br><span class="line">firewall-cmd --zone=public --permanent --add-port=21443/tcp</span><br><span class="line">firewall-cmd --zone=public --permanent --add-port=28517/tcp</span><br><span class="line">output</span><br><span class="line">public (active)</span><br><span class="line">  target: default</span><br><span class="line">  icmp-block-inversion: no</span><br><span class="line">  interfaces: eth0</span><br><span class="line">  sources:</span><br><span class="line">  services: dhcpv6-client ssh http https ftp</span><br><span class="line">  ports: 21443/tcp 28517/tcp</span><br><span class="line">  protocols:</span><br><span class="line">  masquerade: no</span><br><span class="line">  forward-ports:</span><br><span class="line">  source-ports:</span><br><span class="line">  icmp-blocks:</span><br><span class="line">  rich rules:</span><br></pre></td></tr></table></figure>
<p>其实还有很多，都在文章中，可以看看，不过暂时不需要。只要port限制就好.</p>
<h3 id="安装Python，git以及Shadowsock"><a href="#安装Python，git以及Shadowsock" class="headerlink" title="安装Python，git以及Shadowsock"></a>安装Python，git以及Shadowsock</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># install git</span><br><span class="line">yum install git</span><br><span class="line"># install python 2.7 and pip</span><br><span class="line">sudo yum install -y python-setuptools</span><br><span class="line">sudo easy_install pip</span><br><span class="line"># install ssr:</span><br><span class="line">sudo pip install git+https://github.com/shadowsocks/shadowsocks.git@master</span><br></pre></td></tr></table></figure>
<p>接下来就是在服务器里面进行配置了：</p>
<ol>
<li>设置配置文件：vi /etc/shadowsocks/config.json</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;server&quot;: &quot;0.0.0.0&quot;,</span><br><span class="line">&quot;server_port&quot;: 443,</span><br><span class="line">&quot;local_address&quot;: &quot;127.0.0.1&quot;,</span><br><span class="line">&quot;local_port&quot;: 21080,</span><br><span class="line">&quot;password&quot;: &quot;password&quot;,</span><br><span class="line">&quot;timeout&quot;: 300,</span><br><span class="line">&quot;method&quot;: &quot;aes-256-cfb&quot;,</span><br><span class="line">&quot;fast_open&quot;: false,</span><br><span class="line">&quot;workers&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>设置ssr服务为开机启动服务：</li>
</ol>
<p>增加一个开机启动服务service：在/usr/lib/systemd/system中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Shadowsocks</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">ExecStart=/usr/bin/ssserver -c /etc/shadowsocks/config.json</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p>运行以下的命令：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">systemctl enable shadowsocks</span><br><span class="line">systemctl start shadowsocks</span><br><span class="line">systemctl status shadowsocks -l</span><br></pre></td></tr></table></figure>
<ol start="3">
<li><p>远程测试一下  </p>
<p> telnet ip 443</p>
</li>
</ol>
<p>有一个不错的写了安装脚本的，可以看下，学习下:<br>install-shadowsocks.sh:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># Install Shadowsocks on CentOS 7</span><br><span class="line"></span><br><span class="line">echo &quot;Installing Shadowsocks...&quot;</span><br><span class="line"></span><br><span class="line">random-string()</span><br><span class="line">&#123;</span><br><span class="line">    cat /dev/urandom | tr -dc &apos;a-zA-Z0-9&apos; | fold -w $&#123;1:-32&#125; | head -n 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CONFIG_FILE=/etc/shadowsocks.json</span><br><span class="line">SERVICE_FILE=/etc/systemd/system/shadowsocks.service</span><br><span class="line">SS_PASSWORD=$(random-string 32)</span><br><span class="line">SS_PORT=8388</span><br><span class="line">SS_METHOD=aes-256-cfb</span><br><span class="line">SS_IP=`ip route get 1 | awk &apos;&#123;print $NF;exit&#125;&apos;`</span><br><span class="line">GET_PIP_FILE=/tmp/get-pip.py</span><br><span class="line"></span><br><span class="line"># install pip</span><br><span class="line">curl &quot;https://bootstrap.pypa.io/get-pip.py&quot; -o &quot;$&#123;GET_PIP_FILE&#125;&quot;</span><br><span class="line">python $&#123;GET_PIP_FILE&#125;</span><br><span class="line"></span><br><span class="line"># install shadowsocks</span><br><span class="line">pip install --upgrade pip</span><br><span class="line">pip install shadowsocks</span><br><span class="line"></span><br><span class="line"># create shadowsocls config</span><br><span class="line">cat &lt;&lt;EOF | sudo tee $&#123;CONFIG_FILE&#125;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;server&quot;: &quot;0.0.0.0&quot;,</span><br><span class="line">  &quot;server_port&quot;: $&#123;SS_PORT&#125;,</span><br><span class="line">  &quot;password&quot;: &quot;$&#123;SS_PASSWORD&#125;&quot;,</span><br><span class="line">  &quot;method&quot;: &quot;$&#123;SS_METHOD&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># create service</span><br><span class="line">cat &lt;&lt;EOF | sudo tee $&#123;SERVICE_FILE&#125;</span><br><span class="line">[Unit]</span><br><span class="line">Description=Shadowsocks</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">ExecStart=/usr/bin/ssserver -c $&#123;CONFIG_FILE&#125;</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># start service</span><br><span class="line">systemctl enable shadowsocks</span><br><span class="line">systemctl start shadowsocks</span><br><span class="line"></span><br><span class="line"># view service status</span><br><span class="line">sleep 5</span><br><span class="line">systemctl status shadowsocks -l</span><br><span class="line"></span><br><span class="line">echo &quot;================================&quot;</span><br><span class="line">echo &quot;&quot;</span><br><span class="line">echo &quot;Congratulations! Shadowsocks has been installed on your system.&quot;</span><br><span class="line">echo &quot;You shadowsocks connection info:&quot;</span><br><span class="line">echo &quot;--------------------------------&quot;</span><br><span class="line">echo &quot;server:      $&#123;SS_IP&#125;&quot;</span><br><span class="line">echo &quot;server_port: $&#123;SS_PORT&#125;&quot;</span><br><span class="line">echo &quot;password:    $&#123;SS_PASSWORD&#125;&quot;</span><br><span class="line">echo &quot;method:      $&#123;SS_METHOD&#125;&quot;</span><br><span class="line">echo &quot;--------------------------------&quot;</span><br></pre></td></tr></table></figure>
<h3 id="将自己的个人博客转到这个服务器上"><a href="#将自己的个人博客转到这个服务器上" class="headerlink" title="将自己的个人博客转到这个服务器上"></a>将自己的个人博客转到这个服务器上</h3><h4 id="安装Nginx"><a href="#安装Nginx" class="headerlink" title="安装Nginx"></a>安装Nginx</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y update</span><br><span class="line">rpm -ivh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm</span><br><span class="line">yum install nginx</span><br></pre></td></tr></table></figure>
<h4 id="将hexo配置上"><a href="#将hexo配置上" class="headerlink" title="将hexo配置上"></a>将hexo配置上</h4><h5 id="server端的修改"><a href="#server端的修改" class="headerlink" title="server端的修改"></a>server端的修改</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#设置hexo到服务器上</span><br><span class="line">mkdir -p code/gitLibrary/blog/hexo</span><br><span class="line">#设置nginx配置，主要是目录：</span><br><span class="line">sudo vi /etc/nginx/nginx.conf</span><br><span class="line">#在配置中添加以下内容</span><br><span class="line">	http&#123;</span><br><span class="line">			gzip on;</span><br><span class="line">			server &#123;</span><br><span class="line">		      		listen       80 default_server;</span><br><span class="line">		      		listen       [::]:80 default_server;</span><br><span class="line">		      		server_name  blog.domain.com; # 填写个人域名</span><br><span class="line">		      		root         /home/user/code/gitLibrary/blog/hexo;</span><br><span class="line">		 	 &#125;</span><br><span class="line">	&#125;</span><br><span class="line">#修改hexo git配置</span><br><span class="line">cd /home/user/code/gitLibrary/hexo.git/hooks</span><br><span class="line">vi post-update</span><br><span class="line">#添加一下的内容到文件中。 前面是需要上传的地址路径，后面是git的目录地址</span><br><span class="line">git --work-tree=/home/user/code/gitLibrary/blog/hexo --git-dir=/home/user/code/gitLibrary/hexo.git checkout -f</span><br></pre></td></tr></table></figure>
<p>启动nginx：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t</span><br><span class="line">systemctl start nginx</span><br><span class="line">systemctl status nginx</span><br></pre></td></tr></table></figure>
<p><strong>踩了一个坑，nginx老是无法访问对应的文件，然后我检查的时候看到相应的文件都以及设置了可读的权限，但是仍然无法访问。后面自己在建立了一个用户来测试，才发现，对于目录文件来说，权限要设置为可读且可执行的才能被读取里面的文件，也就是755的权限了。</strong>    </p>
<h5 id="本地机器的修改"><a href="#本地机器的修改" class="headerlink" title="本地机器的修改"></a>本地机器的修改</h5><p>修改deploy的git远程机器：</p>
<pre><code>vi /Users/user/code/blog/_config.yml
#deploy中需要改为如下：
deploy:
  type: git
  repo: ssh://user@ip:port/home/user/code/gitLibrary/hexo
  brach: master
</code></pre><h5 id="域名转换"><a href="#域名转换" class="headerlink" title="域名转换"></a>域名转换</h5><p>IP变了，所以要去域名服务商改下ip。<br>比如我这个是在name    上，进入<a href="https://www.name.com/zh-cn/account/domain/details/sevenpan.com#dns" target="_blank" rel="noopener">DNS</a>设置自己的ip就可以进行转发了。      </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.sevenpan.com/2018/11/23/基础建设和杂项比较/RPC,REST,SOAP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Pan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eden">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/23/基础建设和杂项比较/RPC,REST,SOAP/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-23T13:58:11+08:00">
                2018-11-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="RPC，-REST-SOAP"><a href="#RPC，-REST-SOAP" class="headerlink" title="RPC， REST, SOAP"></a>RPC， REST, SOAP</h2><p><a href="https://blog.apisyouwonthate.com/understanding-rpc-rest-and-graphql-2f959aadebe7" target="_blank" rel="noopener">https://blog.apisyouwonthate.com/understanding-rpc-rest-and-graphql-2f959aadebe7</a>  </p>
<h3 id="RPC-Remote-Procedure-Call-RPC"><a href="#RPC-Remote-Procedure-Call-RPC" class="headerlink" title="RPC Remote Procedure Call (RPC)"></a>RPC Remote Procedure Call (RPC)</h3><p>RPC 是最简单最早的一种API交互。它可以执行其他服务器上的代码，并且当用http或者AMQP实现的时候，它就是一个web API.  RPC只是很多的函数但是是在HTTP API 的上下文中， 导致需要将方法放到URL中并且参数放到查询的字符串或者请求中。<br>当被用来执行CRUD操作的时候，RPC只是用来发送和下载数据字段，但是有一个很不好的地方是客户端需要负责很多东西。客户端为了构造它自己的工作流，需要知道哪个方法在什么时候调用。<br>RPC只是一个概念，但是这个概念有很多的要求，这些要求都有对应的实现:</p>
<ol>
<li><a href="https://en.wikipedia.org/wiki/XML-RPC" target="_blank" rel="noopener">XML-RPC</a></li>
<li><a href="https://en.wikipedia.org/wiki/JSON-RPC" target="_blank" rel="noopener">JSON-RPC</a></li>
<li><a href="https://en.wikipedia.org/wiki/SOAP" target="_blank" rel="noopener">Simple Object Access Protocol(SOAP)</a></li>
</ol>
<p>XML-RPC 和JSON-RPC被使用的并不多，而SOAP被使用在大部分的金融和企业系统中，比如Salesforce，其实我之前的公司也是使用的SOAP。<br>XML-RPC在使用的时候由于XML的数据类型无法完全满足，所以会有一些问题。在XML中，很多东西只是字符串而已， JSON对此有一些改进，但是对于区分不同的数据格式比如整形和小数还是有问题。(<b>似乎这里可以看下，是否xml和json有这两个问题</b>)<br>你需要将元数据放到最顶层用于描述字段对应的数据类型。这就是SOAP的一部分基础，使用<a href="https://en.wikipedia.org/wiki/XML_schema" target="_blank" rel="noopener">XML Schema</a>和一个<a href="https://en.wikipedia.org/wiki/Web_Services_Description_Language" target="_blank" rel="noopener">Web Services Description Language(WSDL)</a> 来解释去到哪和包含了什么。<br>插播下什么是XML Schema 和WSDL吧，毕竟以前接触的还比较多，但是一直不太明白它们。  </p>
<pre><code>XML schema 是一个用于描述XML文件类型的东西。通常表示结构的约束和这个文档的内容的类型，是在XML基础之上的一种约束。这些约束通常被表述为语法条件的组合来治理元素的顺序，内容需要满足布尔预测， 数据类型治理元素的内容和状态，以及更多的特殊规则比如唯一性和参照完整性约束。 咳咳，通俗易懂的说，这个文件用于指定一些约束，比如，这个字段是否可以为可选的，还是必须的，如果一个字段有是否也需要另外的字段的存在。也就是可以将一些业务约束或者说是接口约束写入这个文件中，让其进行检查，而不需要在业务代码中进行检查。比较精致的做法是这样，但是在之前的工作中，一般会弃用这个约束，因为该文件的修改设计到外系统的同步，修改比较麻烦，不如完全放松，接口先通，自己进行内部调整。  
WSDL（网络服务描述语言 Web Services Description Language）是一个基于XML的接口定义语言用来描述一个web服务提供的功能。这个缩写也用来表示一个web服务的WSDL描述，提供一个机器可读的描述来告知这个服务可以被调用，它期望的参数是什么，它将返回什么数据结构。所以，WSDL的目的和一个编程语言的类型签名有一些相似。WSDL将服务描述为网络endpoints或者端口的集合。WSDL说明书提供一个XML格式的文档来达到这个目的。抽象定义的端口和信息被从它们的具体使用或者实例中抽离出来，从而允许定义的复用。端口是通过关联一个网络地址的可重复绑定来定义，端口的集合定义了一个服务。这个对于一个端口具体的协议和数据格式规格组成了一个可复用的绑定，而操作和信息会绑定到具体的网络协议和消息格式。通过这样，WSDL描述了这个Web service的公共接口。上面这段描述有些抽象，后续我考虑补充点例子进来。  
</code></pre><p>这些元数据就像是单位。比如是分还是元，很重要咯。<br>一个现代的RPC实现是<a href="https://grpc.io/" target="_blank" rel="noopener">gRPC</a>，可以被简单的考虑为更好的SOAP。它使用了一个数据类型称为<a href="https://developers.google.com/protocol-buffers/" target="_blank" rel="noopener">ProtoBuff</a>,既需要模式也需要数据实例，非常像是SOAP中的WSDL。<br>GRPC专注于使单次交互尽可能的快，它利用了HTTP/2和Protobuff包要小于JSON的特点。但是JSon也可以很容易的使用。  </p>
<h3 id="Representation-State-Transfer-REST"><a href="#Representation-State-Transfer-REST" class="headerlink" title="Representation State Transfer (REST)"></a>Representation State Transfer (REST)</h3><p>REST 是一个网络范式在2000年被Roy Fielding 提出。REST 是关于客户端和服务器端关系的，服务端的数据通过表达数据为简单的格式来达到可用性。这个格式可以是JSON或者XML或者任何东西。<br>这些表达从不同的来源中描述数据，简单称为资源或者资源的集合，它们都是可以通过称为超媒体控件(HATEOAS)的概念使action和关系变得可发现而潜在地可修改。<br>Hypermedia 是REST的基础，本质上是提供接下来可用的操作，这些操作可以是和数据有关，或者一个”Invoice”资源的例子，它可能被链接到一个支付尝试集合，这样这个用户可以尝试支付订单。<br>这些动作只是链接，但是这里的重点是这个客户知道这里有一个订单是可以支付的通过展示一个”支付”链接，并且如果这个链接不存在，那么这个选项也不应该展示给终端用户。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;data&quot;&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;invoice&quot;,</span><br><span class="line">    &quot;id&quot;: &quot;093b941d&quot;,</span><br><span class="line">    &quot;attributes&quot;: &#123;</span><br><span class="line">      &quot;created_at&quot;: &quot;2017–06–15 12:31:01Z&quot;,</span><br><span class="line">      &quot;sent_at&quot;: &quot;2017–06–15 12:34:29Z&quot;,</span><br><span class="line">      &quot;paid_at&quot;: &quot;2017–06–16 09:05:00Z&quot;,</span><br><span class="line">      &quot;status&quot;: &quot;published&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;links&quot;: &#123;</span><br><span class="line">    &quot;pay&quot;: &quot;https://api.acme.com/invoices/093b941d/payment_attempts&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这就和RPC不太一样了。下面两个列子可以说明：</p>
<pre><code>客户：我可以和Dr.A说话么，他在么？
RPC：不行
客户： 我检查了他的日程，看起来今天他不在。我想和其他的医生聊聊，看起来Dr.B下午三点有空，我可以那时见到她么？
RPC：可以。
</code></pre><p>可以看到，客户承担大部分需要做的事情，它需要知道所有的数据，然后自己决定，然后才能弄清楚下一步应该做什么。而REST告诉你下一步应该做什么：</p>
<pre><code>客户：我可以和Dr.A说话么，他在么？
REST: Dr.A 现在不在，他明天会回来，但是你有以下的选项。如果你不急，可以留下信息我明天告诉他或者我可以给你预定今天其他的医生，你想要知道今天谁有空么？  
客户：是的，请告诉我今天有谁。
REST:医生B和C，这是他们的介绍。
客户:医生B看起来像是我需要的，请帮我做预约。
REST：预约已经成功，这是详细的预约内容。
</code></pre><p>REST提供了所有相关的信息在回应中，然后这个客户可以选择想要的选项。<br>在服务器中集中状态对于系统为不同的客户提供相同的工作流程很有用。不同于分布式处理全部逻辑，检查数据字段，展示Action的列表等等，对于不同的用户展示不同的结果，REST将他们都统一了。<br>对于更多超媒体控制，可以查看：<a href="https://blog.apisyouwonthate.com/representing-state-in-rest-and-graphql-9194b291d127" target="_blank" rel="noopener">Representing State in REST and GraphQL</a>和 <a href="http://apibusters.com/003-why-hypermedia" target="_blank" rel="noopener">API busters podcast- Episode 3:Why Hypermedia</a>.<br>除了超媒体(最有用但是也是最容易忽视的特点)对于一个系统拥有REST API还有其他的要求：</p>
<ol>
<li>REST必须是无状态的：请求之间没有持续的session。</li>
<li>回应应该是可缓存的：这样可以帮助你的API进行扩展，如果客户遵守这些规则。</li>
<li>REST 关注一致性：如果使用HTTP，应该尽可能使用HTTP特性，而不是创造约定。</li>
</ol>
<p>这些约束的目标是使REST架构可以帮助API持续使用。<br>REST同样也不需要使用模式元数据，那些API开发员最讨厌SOAP的东西。很长一段时间没人构建REST APIs通过schema，但是现在这个变的比较普遍由于<a href="http://json-schema.org/" target="_blank" rel="noopener">JSON Schema</a>。<br>JSON Schema是从XML Schema激发出来的，不是完全的功能一致，但是是HTTP API这些年中最重要的事情之一。<br>很不幸的是，REST变成了一个营销词语在2006-2014之间。它变成了程序员渴望的一种质量衡量方式，而不是去理解，然后就到处使用REST，所以很多系统说他们是REST但是只是RPC加上HTTP词语以及漂亮的URLs。你可能并不能获取任何缓存的东西，也许它只是一堆奇怪的对话，并且你并不能发现任何可以进行下一步的链接。<br>在另外一个方面，一个REST API可以被用为RPC风格的，如果客户端的开发忽略这些链接的话。这是不可取的，但是这是可能的。<br>很多人对于REST的困惑在于他们无法理解“所有额外的烦恼”，比如超媒体控制和HTTP缓存。他们没有看到这点，并且很多觉得RPC是全能的。对于他们来说，最重要的是尽可能快的执行远程代码，但是REST(同样是是高性能的)专注于longevity 和减少客户的耦合。<br>REST理论上可以使用任何的传输协议来提供满足约束的功能，但是没有传输协议可以像HTTP一样有功能性。为了使AMQP符合RET，你需要定义超媒体来控制(可能是下一个你可能调用的信息列表)，一个标准的用来声明AMQP信息的缓存性等， 并且创造很多并不存在的工具。<br>REST没有固定的规格所以导致有这些困惑，并且它也没有具体的实现。目前这有两个很受欢迎的规格提供给REST APIs来使用：  </p>
<ol>
<li><a href="http://www.odata.org/" target="_blank" rel="noopener">OData</a></li>
<li><a href="http://jsonapi.org/" target="_blank" rel="noopener">JSON-API</a></li>
</ol>
<p>如果有API宣传它自己使用了这两，它有可能是一个不错的api。你可以使用这两个作为你的客户端或者你使用一个普通的http客户端，并且自己添加一些润滑油。  </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.sevenpan.com/2018/11/07/Algo/配对交易策略RQ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Pan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eden">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/07/Algo/配对交易策略RQ/" itemprop="url">配对交易策略</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-07T16:21:17+08:00">
                2018-11-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#配对交易策略 - 初1</p>
<p>又名搬砖策略：<br><a href="https://uqer.io/v3/community/share/57b6a1b4228e5b79a375925c" target="_blank" rel="noopener">https://uqer.io/v3/community/share/57b6a1b4228e5b79a375925c</a>  </p>
<p>几个基本的问题：</p>
<ol>
<li>如何找到股票相关性高的股票？</li>
<li>怎么确定股票比较之间的长期稳定关系</li>
<li>怎么依据长期稳定关系来建立策略</li>
</ol>
<h2 id="另外一个pariTrading的介绍"><a href="#另外一个pariTrading的介绍" class="headerlink" title="另外一个pariTrading的介绍"></a>另外一个pariTrading的介绍</h2><p><a href="https://medium.com/auquan/pairs-trading-data-science-7dbedafcfe5a" target="_blank" rel="noopener">https://medium.com/auquan/pairs-trading-data-science-7dbedafcfe5a</a><br>多重比较偏差：会有增加的错误生成一个明显的p-value的可能性当有太多的测试在运行的时候。 如果100个测试运行在随机数据上，我们应该期望看到5个p-value低于0.05.如果你比较n个证券，你将会执行n((n-1)/2次比较，你将会希望看到很多不正确的p-valus,他们将会随着你增加比较次数而增加。为了避免这个问题，你应该选择小数量的对来测试可能协整并且测试单独测试每一个。<br><b>？？？ 为啥测的多了可能会产生过多的错误的结果？还是不太懂。然后比较小的数量，这个数量应该怎么确定了？</b><br>接下来文章中介绍的是使用标普500的股票数据来产生交易对。文章提到：<br><b>This method is prone to multiple comparison bias and in practice the securities should be subject to a second verification step.</b><br>这里面的二次验证是指？  </p>
<p>Z Score(Value) = (Value - Mean)/Standard Deviation<br>在实际操作中，常常试图对数据做一定的扩展，但是这是在假设了一个底部的分布时候。 通常是正太分布。然而，很多金融数据并不是正太分布的，我们必须很小心，而不是简单的假设为正太分布或者特定的分布，当生成统计时。真正的比率分布可能会十分的肥尾，倾向于极端的价值弄乱了我们的模型，并且产生很大的损失。  </p>
<p><b>fat-tailed distribution</b><br>    <a href="https://en.wikipedia.org/wiki/Fat-tailed_distribution" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Fat-tailed_distribution</a></p>
<pre><code>A fat-tailed distribution is a probability distribution that exhibits a large skewness or kurtosis, relative to that of either a normal distribution or an exponential distribution.  
长尾分布是一个概率分布展示了很大的偏差或者峰度相对于一个正太分布或者一个预期内的分布而说。  
</code></pre><p>产生一个交易信号有以下的几个步骤：  </p>
<ol>
<li>收集可靠的数据，清理数据</li>
<li>从数据中创造特征来识别一个交易信号或者逻辑</li>
<li>特征可以是Moving Average 或者价格数据的比例，相关性或者更多复杂的信号 — 将它们联合起来创造更多的特征。  </li>
<li>通过这些特征来生成信号，比如交易品应该买，买或者中性。  </li>
</ol>
<p>在这篇文章中，产生一个配对交易策略的步骤可以如下：</p>
<ol>
<li>我们试图创造一个信号来告诉我们是否这个比例应买或者卖 在下一个时间里。比如这个ratio是Y<br> Y(t) = Sign(Ratio(t+1) - Ratio(t))</li>
<li>获取数据，此处广告省略了。</li>
<li>分割数据，70%用于训练，30%用于测试。</li>
<li>特征构建<br> 相关特征应该是哪些？我们想要预测ratio的移动方向。我们已经看到两个证券是协整的，所以这个ratio将会在mean值之间上下运动。当前值和mean的差将会用于生成交易信号。<br> 我们使用以下的特征：  <ol>
<li>60天移动平均线：滚动平均值的测量</li>
<li>5天移动平均线： 测量的当前均值</li>
<li>60天的标准偏差</li>
<li>z score： (5d MA — 60d MA) /60d SD</li>
</ol>
</li>
<li><p>模型的选择<br> 研究z-score的图表可以看出来，无论这个值太大或者太小它都将会回复到均值的水平。我们使用+1/-1作为阀值来代表过高或者太低，然后我们可以采用以下模型来生成一个交易信号：<br> Ratio 是buy(1)当z-score低于-1.0时，因为我们期望z score将会回到0，也就是增加.<br> Ratio 是sell(-1)当z-score高于1.0时，因为我们期望z score将会回到0，也就是降低.</p>
</li>
<li><p>训练，校验和优化</p>
</li>
</ol>
<h3 id="避免过度拟合"><a href="#避免过度拟合" class="headerlink" title="避免过度拟合"></a>避免过度拟合</h3><p>在上述模型中，使用了rolling参数来创建而且也许希望来优化窗口大小。我们也许可以使用一个简单的迭代来计算全部的可能的窗口大小，然后使用最好的表现的窗口大小。但是就是会有过度拟合的问题。为了解决这个问题，这个文章里提到的是使用经济学的解释或者使用算法的特性来选择窗口长度。当然还有一个方法： Kalman filter，这个据说不需要制定一个特定的长度，我准备接下来看下这个。  </p>
<h3 id="更多信息"><a href="#更多信息" class="headerlink" title="更多信息"></a>更多信息</h3><p>上述只是一个简单的开发pairtrading策略的过程，在现实中，我们应该使用更复杂的统计学方式，比如：</p>
<pre><code>1. Hurst Exponent
2. Half-life of mean reversion inferred from an Ornstein-Uhlenbeck process
3. Kalman filters
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.sevenpan.com/2018/10/17/Algo/Somethings About Pyalgotrade/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Pan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eden">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/17/Algo/Somethings About Pyalgotrade/" itemprop="url">Somethings About Pyalgotrade  - the Optimizing</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-17T13:27:39+08:00">
                2018-10-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://gbeced.github.io/pyalgotrade/docs/v0.20/html/tutorial.html#optimizing" target="_blank" rel="noopener">http://gbeced.github.io/pyalgotrade/docs/v0.20/html/tutorial.html#optimizing</a></p>
<h2 id="The-optimizing"><a href="#The-optimizing" class="headerlink" title="The optimizing"></a>The optimizing</h2><p>优化，💡很简单：</p>
<pre><code>一台server用于：
    1. 提供bars用来运行策略
    2. 提供参数用来运行策略
    3. 记录每一个worker的运行策略的结果
很多worker用来：
    使用server提供的参数和数据来运行策略
</code></pre><p>为了展示这个，我们将会使用一个称为RSI2的策略，该策略需要以下的参数：</p>
<pre><code>一个SMA时间段用于区分趋势。我们将会将这个参数称为entrySMA，并且范围选取在150和250之间。  
一个小一些的SMA时间段用于退出参数。我们称之为exitSMA，范围在5到15之间。  
一个RSI时间段用于进入买或者卖，我们称之为rsiPeriod，范围在2到10之间。  
一个RSI超卖阀值用于进入买入点位，我们称之为overSoldThreshold，并且范围在5和25之间。  
一个RSI超买阀值用于进入卖出点位，我们称之为overBoughtThreshold，范围将在75和95之间。
</code></pre><p><b>所以这里一共有：101 <em> 11 </em> 9 <em> 21 </em> 21 = 4409559</b><br>如果一个策略需要运行0.16秒，那么一共需要8.5天才能算出所有的策略。(4409559 <em> 0.16/3600/24 ～ 8.16 Days)<br>如果是利用上了10台八核的机器，时间将会缩短到2.5个小时。（4409559 </em> 0.16/3600/24/8/10 * 24(h) ~ 2.44 h) 所以我们需要并发。  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyalgotrade <span class="keyword">import</span> strategy</span><br><span class="line"><span class="keyword">from</span> pyalgotrade.technical <span class="keyword">import</span> ma</span><br><span class="line"><span class="keyword">from</span> pyalgotrade.technical <span class="keyword">import</span> rsi</span><br><span class="line"><span class="keyword">from</span> pyalgotrade.technical <span class="keyword">import</span> cross</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RSI2</span><span class="params">(strategy.BacktestingStrategy)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, feed, instrument, entrySMA, exitSMA, rsiPeriod, overBoughtThreshold, overSoldThreshold)</span>:</span></span><br><span class="line">        super(RSI2, self).__init__(feed)</span><br><span class="line">        self.__instrument = instrument</span><br><span class="line">        <span class="comment"># We'll use adjusted close values, if available, instead of regular close values.</span></span><br><span class="line">        <span class="keyword">if</span> feed.barsHaveAdjClose():</span><br><span class="line">            self.setUseAdjustedValues(<span class="keyword">True</span>)</span><br><span class="line">        self.__priceDS = feed[instrument].getPriceDataSeries()</span><br><span class="line">        self.__entrySMA = ma.SMA(self.__priceDS, entrySMA)</span><br><span class="line">        self.__exitSMA = ma.SMA(self.__priceDS, exitSMA)</span><br><span class="line">        self.__rsi = rsi.RSI(self.__priceDS, rsiPeriod)</span><br><span class="line">        self.__overBoughtThreshold = overBoughtThreshold</span><br><span class="line">        self.__overSoldThreshold = overSoldThreshold</span><br><span class="line">        self.__longPos = <span class="keyword">None</span></span><br><span class="line">        self.__shortPos = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getEntrySMA</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__entrySMA</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getExitSMA</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__exitSMA</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getRSI</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__rsi</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">onEnterCanceled</span><span class="params">(self, position)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.__longPos == position:</span><br><span class="line">            self.__longPos = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">elif</span> self.__shortPos == position:</span><br><span class="line">            self.__shortPos = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">assert</span>(<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">onExitOk</span><span class="params">(self, position)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.__longPos == position:</span><br><span class="line">            self.__longPos = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">elif</span> self.__shortPos == position:</span><br><span class="line">            self.__shortPos = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">assert</span>(<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">onExitCanceled</span><span class="params">(self, position)</span>:</span></span><br><span class="line">        <span class="comment"># If the exit was canceled, re-submit it.</span></span><br><span class="line">        position.exitMarket()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">onBars</span><span class="params">(self, bars)</span>:</span></span><br><span class="line">        <span class="comment"># Wait for enough bars to be available to calculate SMA and RSI.</span></span><br><span class="line">        <span class="keyword">if</span> self.__exitSMA[<span class="number">-1</span>] <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> self.__entrySMA[<span class="number">-1</span>] <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> self.__rsi[<span class="number">-1</span>] <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        bar = bars[self.__instrument]</span><br><span class="line">        <span class="keyword">if</span> self.__longPos <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">if</span> self.exitLongSignal():</span><br><span class="line">                self.__longPos.exitMarket()</span><br><span class="line">        <span class="keyword">elif</span> self.__shortPos <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">if</span> self.exitShortSignal():</span><br><span class="line">                self.__shortPos.exitMarket()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> self.enterLongSignal(bar):</span><br><span class="line">                shares = int(self.getBroker().getCash() * <span class="number">0.9</span> / bars[self.__instrument].getPrice())</span><br><span class="line">                self.__longPos = self.enterLong(self.__instrument, shares, <span class="keyword">True</span>)</span><br><span class="line">            <span class="keyword">elif</span> self.enterShortSignal(bar):</span><br><span class="line">                shares = int(self.getBroker().getCash() * <span class="number">0.9</span> / bars[self.__instrument].getPrice())</span><br><span class="line">                self.__shortPos = self.enterShort(self.__instrument, shares, <span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enterLongSignal</span><span class="params">(self, bar)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> bar.getPrice() &gt; self.__entrySMA[<span class="number">-1</span>] <span class="keyword">and</span> self.__rsi[<span class="number">-1</span>] &lt;= self.__overSoldThreshold</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exitLongSignal</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cross.cross_above(self.__priceDS, self.__exitSMA) <span class="keyword">and</span> <span class="keyword">not</span> self.__longPos.exitActive()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enterShortSignal</span><span class="params">(self, bar)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> bar.getPrice() &lt; self.__entrySMA[<span class="number">-1</span>] <span class="keyword">and</span> self.__rsi[<span class="number">-1</span>] &gt;= self.__overBoughtThreshold</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exitShortSignal</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cross.cross_below(self.__priceDS, self.__exitSMA) <span class="keyword">and</span> <span class="keyword">not</span> self.__shortPos.exitActive()</span><br></pre></td></tr></table></figure>
<p>有以下的函数被定义：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#获取进入SMA的值，range从150到250</span></span><br><span class="line">getEntrySMA(self)</span><br><span class="line"><span class="comment">#获取退出SMA的值，range从5到16</span></span><br><span class="line">getExitSMA(self)</span><br><span class="line"><span class="comment">#获取rsi 时段的值，range从2到10</span></span><br><span class="line">getRSI(self)</span><br><span class="line"><span class="comment">#取消建仓逻辑 --- 这里不太明白为什么要增加</span></span><br><span class="line">onEnterCanceled(self, position)</span><br><span class="line"><span class="comment">#平仓逻辑 --- 这里不太明白为什么要增加	</span></span><br><span class="line">onExitOk(self, position)</span><br><span class="line"><span class="comment">#平仓取消逻辑 --- 这里不太明白为什么要增加	</span></span><br><span class="line">onExitCanceled(self, position)</span><br><span class="line"><span class="comment">#策略执行逻辑</span></span><br><span class="line">onBars(self, bars)</span><br><span class="line"><span class="comment">#做多信号</span></span><br><span class="line">enterLongSignal(self, bar)</span><br><span class="line"><span class="comment">#退出做多信号</span></span><br><span class="line">exitLongSignal(self)</span><br><span class="line"><span class="comment">#做空信号</span></span><br><span class="line">enterShortSignal(self, bar)</span><br><span class="line"><span class="comment">#退出做空信号</span></span><br><span class="line">exitShortSignal(self)</span><br></pre></td></tr></table></figure>
<p>其中，onBars(self, bars)函数用于执行策略逻辑，在onBars中，如果目前有仓位，调用了exitLongSignal() 和 exitShortSignal 用于判断是非要执行平仓操作。如果目前空仓，则调用了enterLongSignal()和enterShortSignal()来决定是否建仓。其中，getBroker().getCash()可以获取当前的现金，0.9应该是估算了交易费用。而其中的enterShort()和enterLong()函数应该是BacktestingStrategy类所含有的函数。  </p>
<p>从上面一段函数基本逻辑可以分析出，Pyalgotrade 有两个基本的类，我需要关注：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyalgotrade <span class="keyword">import</span> strategy</span><br><span class="line">strategy.BacktestingStrategy</span><br><span class="line">position</span><br><span class="line">pyalgotrade.technical</span><br><span class="line">```   </span><br><span class="line"></span><br><span class="line">然后还有旁枝但是不用太过关心的类：</span><br><span class="line">	</span><br><span class="line">	feed</span><br><span class="line">	<span class="keyword">from</span> pyalgotrade.barfeed <span class="keyword">import</span> quandlfeed</span><br><span class="line">	feed = quandlfeed.Feed()</span><br><span class="line">回到优化这个主题上来，server的代码如下：</span><br></pre></td></tr></table></figure>
<p>import itertools<br>from pyalgotrade.optimizer import server<br>from pyalgotrade.barfeed import quandlfeed</p>
<p>def parameters_generator():<br>    instrument = [“ibm”]<br>    entrySMA = range(150, 251)<br>    exitSMA = range(5, 16)<br>    rsiPeriod = range(2, 11)<br>    overBoughtThreshold = range(75, 96)<br>    overSoldThreshold = range(5, 26)<br>    return itertools.product(instrument, entrySMA, exitSMA, rsiPeriod, overBoughtThreshold, overSoldThreshold)</p>
<h1 id="The-if-name-‘main‘-part-is-necessary-if-running-on-Windows"><a href="#The-if-name-‘main‘-part-is-necessary-if-running-on-Windows" class="headerlink" title="The if name == ‘main‘ part is necessary if running on Windows."></a>The if <strong>name</strong> == ‘<strong>main</strong>‘ part is necessary if running on Windows.</h1><p>if <strong>name</strong> == ‘<strong>main</strong>‘:</p>
<pre><code># Load the bar feed from the CSV files.
feed = quandlfeed.Feed()
feed.addBarsFromCSV(&quot;ibm&quot;, &quot;WIKI-IBM-2009-quandl.csv&quot;)
feed.addBarsFromCSV(&quot;ibm&quot;, &quot;WIKI-IBM-2010-quandl.csv&quot;)
feed.addBarsFromCSV(&quot;ibm&quot;, &quot;WIKI-IBM-2011-quandl.csv&quot;)

# Run the server.
server.serve(feed, parameters_generator(), &quot;localhost&quot;, 5000)
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">这个代码处理了三个事情：</span><br><span class="line"></span><br><span class="line">1. 声明了一个生成器函数根据范围产生不同的参数。</span><br><span class="line">2. 加载csv文件到feed中。</span><br><span class="line">3. 运行server监听5000端口来获取到来的链接。</span><br><span class="line"></span><br><span class="line">worker 脚本使用了 `pyalgotrade.optimizer.worker` 模块来并行运行策略，并且使用了server提供的数据。</span><br></pre></td></tr></table></figure>
<p>from pyalgotrade.optimizer import worker<br>import rsi2</p>
<h1 id="The-if-name-‘main‘-part-is-necessary-if-running-on-Windows-1"><a href="#The-if-name-‘main‘-part-is-necessary-if-running-on-Windows-1" class="headerlink" title="The if name == ‘main‘ part is necessary if running on Windows."></a>The if <strong>name</strong> == ‘<strong>main</strong>‘ part is necessary if running on Windows.</h1><p>if <strong>name</strong> == ‘<strong>main</strong>‘:<br>    worker.run(rsi2.RSI2, “localhost”, 5000, workerName=”localworker”)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;b&gt;注意你应该在一台server和大于等于一个worker的情况下运行&lt;/b&gt;</span><br><span class="line">如果你只是想要在你的台式机上并发运行策略，那么可以利用`pyalgotrade.optimizer.local `模块来处理如下：  </span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line">import itertools</span><br><span class="line">from pyalgotrade.optimizer import local</span><br><span class="line">from pyalgotrade.barfeed import quandlfeed</span><br><span class="line">import rsi2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def parameters_generator():</span><br><span class="line">    instrument = [&quot;ibm&quot;]</span><br><span class="line">    entrySMA = range(150, 251)</span><br><span class="line">    exitSMA = range(5, 16)</span><br><span class="line">    rsiPeriod = range(2, 11)</span><br><span class="line">    overBoughtThreshold = range(75, 96)</span><br><span class="line">    overSoldThreshold = range(5, 26)</span><br><span class="line">    return itertools.product(instrument, entrySMA, exitSMA, rsiPeriod, overBoughtThreshold, overSoldThreshold)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># The if __name__ == &apos;__main__&apos; part is necessary if running on Windows.</span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    # Load the bar feed from the CSV files.</span><br><span class="line">    feed = quandlfeed.Feed()</span><br><span class="line">    feed.addBarsFromCSV(&quot;ibm&quot;, &quot;WIKI-IBM-2009-quandl.csv&quot;)</span><br><span class="line">    feed.addBarsFromCSV(&quot;ibm&quot;, &quot;WIKI-IBM-2010-quandl.csv&quot;)</span><br><span class="line">    feed.addBarsFromCSV(&quot;ibm&quot;, &quot;WIKI-IBM-2011-quandl.csv&quot;)</span><br><span class="line"></span><br><span class="line">    local.run(rsi2.RSI2, feed, parameters_generator())</span><br></pre></td></tr></table></figure></p>
<p>这段代码做了3件事情：</p>
<ol>
<li>声明了一个生成函数用来产出不同的参数组合</li>
<li>从csv中加载到feed中</li>
<li>使用<code>pyalgotrade.optimizer.local</code>来并发运行策略，并且找到最好的组合。  </li>
</ol>
<p>上面一段并发的演示说明如果我想要并发运行，也许我需要看看：  </p>
<pre><code>#单机本地并发代码
from pyalgotrade.optimizer import local
local.run(rsi2.RSI2, feed, parameters_generator())
#多台机器并发的代码
from pyalgotrade.optimizer import worker
worker.run(rsi2.RSI2, &quot;localhost&quot;, 5000, workerName=&quot;localworker&quot;)
</code></pre><p><b>以及说明pyalgotrade的优化部分应该是利用了并发来加速。</b><br>对于我自己的处理，可以考虑加入PSO 优化用于处理。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.sevenpan.com/2018/10/13/基础建设和杂项比较/hexoWithGit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Pan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eden">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/13/基础建设和杂项比较/hexoWithGit/" itemprop="url">Hexo With Git</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-13T22:18:38+08:00">
                2018-10-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="server"><a href="#server" class="headerlink" title="server"></a>server</h2><p>环境：  </p>
<pre><code>ubuntu 16.01LTS
</code></pre><p><b>nginx:</b><br>安装 nginx：</p>
<pre><code>sudo apt-get update
sudo apt-get install nginx
</code></pre><p>配置：  </p>
<pre><code>/etc/nginx/nginx.conf
....
server {
          listen       80 default_server;
          listen       [::]:80 default_server;
          server_name  blog.example.com; # 填写个人域名
          root         /home/where/your/blog/hexo;
  }    
  .....
</code></pre><p>/etc/nginx/sites-enabled 中有一个default文件，如果不需要可以删除，否则启动nginx的时候会报端口冲突。<br>启动nginx：</p>
<pre><code>sudo nginx -t
sudo systemctl reload nginx.service
</code></pre><p><b>git:</b><br>    本部分一大段来自：<a href="https://www.jianshu.com/p/e03e363713f9" target="_blank" rel="noopener">https://www.jianshu.com/p/e03e363713f9</a><br>    安装 git：</p>
<pre><code>sudo apt-get install git-core
mkdir -p /home/git/blog/hexo.git #Git仓库，不存储网站文件
mkdir /home/git/blog/hexo #实际存储网站文件目录
</code></pre><p>初始化空的Git仓库：</p>
<pre><code>git init --bare /home/git/blog/hexo.git
</code></pre><p>进入该仓库，配置post-update hooks（有的可能是post-receive）：</p>
<pre><code>cd /home/git/blog/hexo.git/hooks
sudo nano /home/git/blog/hexo.git/hooks/post-update.sample        
git --work-tree=/home/git/blog/hexo --git-dir=/home/git/blog/hexo.git checkout -f
chmod +x post-update
</code></pre><h2 id="local"><a href="#local" class="headerlink" title="local"></a>local</h2><p>本机设置<br>安装hexo相关：</p>
<pre><code>npm install hexo-cli hexo-server hexo-deployer-git -g
</code></pre><p>安装完成后，初始化：</p>
<pre><code>hexo init ~/myBlog
</code></pre><p>修改hexo的配置可以参考：<a href="https://hexo.io/docs/configuration" target="_blank" rel="noopener">https://hexo.io/docs/configuration</a><br>其中 deploy部分需要修改如下：</p>
<pre><code>deploy:     //发布对应的github账号
type: git
repo: user@remoteServer:/home/git/blog/hexo  //用户名@域名或 IP 地址:/home/git/blog/hexo
branch: master
</code></pre><p>然后还有一点，需要ssh-copy-key 将自己的公钥拷贝到远程机器上，这样可以无需密码访问，具体请自行搜索下。</p>
<p>完成以上之后，部署三条命令：</p>
<pre><code>hexo clean
hexo generate
hexo deploy
</code></pre><h2 id="域名转换"><a href="#域名转换" class="headerlink" title="域名转换"></a>域名转换</h2><p>如果有自己的域名，可以在自己的域名服务商上进行设置，这样就可以直接访问域名了。<br>比如我这个是在name    上，进入<a href="https://www.name.com/zh-cn/account/domain/details/sevenpan.com#dns" target="_blank" rel="noopener">DNS</a>设置自己的ip就可以进行转发了。</p>
<h2 id="Reference-Link"><a href="#Reference-Link" class="headerlink" title="Reference Link"></a>Reference Link</h2><p>Hexo: <a href="https://hexo.io/docs/" target="_blank" rel="noopener">https://hexo.io/docs/</a><br>nginx install :    <a href="https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-16-04" target="_blank" rel="noopener">https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-16-04</a><br><a href="https://websiteforstudents.com/migrate-nginx-root-directory-on-ubuntu-17-04-17-10/" target="_blank" rel="noopener">https://websiteforstudents.com/migrate-nginx-root-directory-on-ubuntu-17-04-17-10/</a><br>name.com 域名解析：<a href="http://www.webgou.info/content/netusage/453/" target="_blank" rel="noopener">http://www.webgou.info/content/netusage/453/</a><br>主要参考的两个网页：<br><a href="https://segmentfault.com/a/1190000010680022" target="_blank" rel="noopener">https://segmentfault.com/a/1190000010680022</a><br><a href="https://www.jianshu.com/p/e03e363713f9" target="_blank" rel="noopener">https://www.jianshu.com/p/e03e363713f9</a>  </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Pan" />
          <p class="site-author-name" itemprop="name">Pan</p>
           
              <p class="site-description motion-element" itemprop="description">computer, finance, some recording</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Pan</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
